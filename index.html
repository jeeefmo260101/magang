<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Magang & PKL - BPS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
            animation: slideInRight 0.3s ease-out;
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        .sidebar-transition {
            transition: all 0.3s ease-in-out;
        }
        .content-transition {
            transition: margin-left 0.3s ease-in-out;
        }
        .editing-mode {
            background-color: #fef3c7 !important;
            border-left: 4px solid #f59e0b;
        }
        .editing-mode:hover {
            background-color: #fef3c7 !important;
        }
        .editable-field .edit-input {
            transition: all 0.2s ease;
        }
        .editable-field .edit-input:focus {
            ring: 2px;
            ring-color: #3b82f6;
            border-color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center">
            <div class="loading mx-auto mb-4"></div>
            <p class="text-gray-600">Memproses permintaan...</p>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md mx-4 fade-in">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-building text-white text-2xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">Dashboard Magang & PKL</h2>
                <p class="text-gray-600 mt-2">Badan Pusat Statistik</p>
            </div>

            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="loginUsername" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                           placeholder="Masukkan username">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <div class="relative">
                        <input type="password" id="loginPassword" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all pr-12"
                               placeholder="Masukkan password">
                        <button type="button" onclick="togglePassword('loginPassword')" 
                                class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <button type="submit" 
                        class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium">
                    <span id="loginButtonText">Masuk</span>
                    <div id="loginButtonLoading" class="loading hidden"></div>
                </button>
            </form>

            <div class="mt-6 text-center">
                <p class="text-sm text-gray-600">Belum punya akun?</p>
                <button onclick="showRegisterModal()" 
                        class="text-blue-600 hover:text-blue-700 font-medium">Daftar Sekarang</button>
            </div>

            <div class="mt-4 text-center">
                <button onclick="initializeAdmin()" 
                        class="text-xs text-gray-500 hover:text-gray-700">Inisialisasi Admin</button>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="registerModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md mx-4 max-h-screen overflow-y-auto fade-in">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Daftar Akun Baru</h2>
                <p class="text-gray-600 mt-2">Lengkapi data untuk mendaftar</p>
            </div>

            <form id="registerForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap *</label>
                    <input type="text" id="regNamaLengkap" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username *</label>
                    <input type="text" id="regUsername" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                    <input type="email" id="regEmail" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password *</label>
                    <div class="relative">
                        <input type="password" id="regPassword" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent pr-12">
                        <button type="button" onclick="togglePassword('regPassword')" 
                                class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Role *</label>
                    <select id="regRole" required 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Pilih Role</option>
                        <option value="Peserta Magang">Peserta Magang</option>
                        <option value="Peserta PKL">Peserta PKL</option>
                        <option value="Pembimbing BPS">Pembimbing BPS</option>
                        <option value="Admin">Admin</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">No. Telepon</label>
                    <input type="tel" id="regNoTelepon" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>

                <div class="flex space-x-3 pt-4">
                    <button type="button" onclick="hideRegisterModal()" 
                            class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition-colors">
                        Batal
                    </button>
                    <button type="submit" 
                            class="flex-1 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors">
                        <span id="registerButtonText">Daftar</span>
                        <div id="registerButtonLoading" class="loading hidden"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md mx-4 max-h-screen overflow-y-auto fade-in">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-user-plus text-white text-2xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">Tambah User Baru</h2>
                <p class="text-gray-600 mt-2">Lengkapi data untuk menambah user</p>
            </div>

            <form id="addUserForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap *</label>
                    <input type="text" id="addUserNamaLengkap" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username *</label>
                    <input type="text" id="addUserUsername" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                    <input type="email" id="addUserEmail" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password *</label>
                    <div class="relative">
                        <input type="password" id="addUserPassword" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent pr-12">
                        <button type="button" onclick="togglePassword('addUserPassword')" 
                                class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Role *</label>
                    <select id="addUserRole" required 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Pilih Role</option>
                        <option value="Admin">Admin</option>
                        <option value="Pembimbing BPS">Pembimbing BPS</option>
                        <option value="Peserta Magang">Peserta Magang</option>
                        <option value="Peserta PKL">Peserta PKL</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">No. Telepon</label>
                    <input type="tel" id="addUserNoTelepon" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Status *</label>
                    <select id="addUserStatus" required 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="Aktif">Aktif</option>
                        <option value="Pending">Pending</option>
                        <option value="Nonaktif">Nonaktif</option>
                    </select>
                </div>

                <div class="flex space-x-3 pt-4">
                    <button type="button" onclick="hideAddUserModal()" 
                            class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition-colors">
                        <i class="fas fa-times mr-2"></i>Batal
                    </button>
                    <button type="submit" 
                            class="flex-1 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors">
                        <span id="addUserButtonText"><i class="fas fa-save mr-2"></i>Simpan</span>
                        <div id="addUserButtonLoading" class="loading hidden"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md mx-4 max-h-screen overflow-y-auto fade-in">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-yellow-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-user-edit text-white text-2xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">Edit User</h2>
                <p class="text-gray-600 mt-2">Ubah data user</p>
            </div>

            <form id="editUserForm" class="space-y-4">
                <input type="hidden" id="editUserId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap *</label>
                    <input type="text" id="editUserNamaLengkap" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username *</label>
                    <input type="text" id="editUserUsername" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                    <input type="email" id="editUserEmail" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Role *</label>
                    <select id="editUserRole" required 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                        <option value="">Pilih Role</option>
                        <option value="Admin">Admin</option>
                        <option value="Pembimbing BPS">Pembimbing BPS</option>
                        <option value="Peserta Magang">Peserta Magang</option>
                        <option value="Peserta PKL">Peserta PKL</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">No. Telepon</label>
                    <input type="tel" id="editUserNoTelepon" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Status *</label>
                    <select id="editUserStatus" required 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                        <option value="Aktif">Aktif</option>
                        <option value="Pending">Pending</option>
                        <option value="Nonaktif">Nonaktif</option>
                    </select>
                </div>

                <div class="flex space-x-3 pt-4">
                    <button type="button" onclick="hideEditUserModal()" 
                            class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition-colors">
                        <i class="fas fa-times mr-2"></i>Batal
                    </button>
                    <button type="submit" 
                            class="flex-1 bg-yellow-600 text-white py-3 rounded-lg hover:bg-yellow-700 transition-colors">
                        <span id="editUserButtonText"><i class="fas fa-save mr-2"></i>Update</span>
                        <div id="editUserButtonLoading" class="loading hidden"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- View User Modal -->
    <div id="viewUserModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md mx-4 fade-in">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-user text-white text-2xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">Detail User</h2>
            </div>

            <div class="space-y-4">
                <div class="bg-gray-50 p-4 rounded-lg">
                    <label class="block text-sm font-medium text-gray-600 mb-1">Nama Lengkap</label>
                    <p id="viewUserNamaLengkap" class="text-gray-800 font-medium">-</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <label class="block text-sm font-medium text-gray-600 mb-1">Username</label>
                    <p id="viewUserUsername" class="text-gray-800 font-medium">-</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <label class="block text-sm font-medium text-gray-600 mb-1">Email</label>
                    <p id="viewUserEmail" class="text-gray-800 font-medium">-</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <label class="block text-sm font-medium text-gray-600 mb-1">Role</label>
                    <p id="viewUserRole" class="text-gray-800 font-medium">-</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <label class="block text-sm font-medium text-gray-600 mb-1">No. Telepon</label>
                    <p id="viewUserNoTelepon" class="text-gray-800 font-medium">-</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <label class="block text-sm font-medium text-gray-600 mb-1">Status</label>
                    <p id="viewUserStatus" class="text-gray-800 font-medium">-</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <label class="block text-sm font-medium text-gray-600 mb-1">Tanggal Dibuat</label>
                    <p id="viewUserTanggalDibuat" class="text-gray-800 font-medium">-</p>
                </div>
            </div>

            <div class="mt-6">
                <button onclick="hideViewUserModal()" 
                        class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition-colors">
                    <i class="fas fa-check mr-2"></i>Tutup
                </button>
            </div>
        </div>
    </div>

    <!-- Add Peserta Modal -->
    <div id="addPesertaModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-2xl mx-4 max-h-screen overflow-y-auto fade-in">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-user-graduate text-white text-2xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">Tambah Peserta Baru</h2>
                <p class="text-gray-600 mt-2">Lengkapi data peserta magang/PKL</p>
            </div>

            <form id="addPesertaForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap *</label>
                        <input type="text" id="addPesertaNamaLengkap" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">NIM/NISN *</label>
                        <input type="text" id="addPesertaNimNisn" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Asal Sekolah/PT *</label>
                        <input type="text" id="addPesertaAsalSekolahPT" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Jurusan *</label>
                        <input type="text" id="addPesertaJurusan" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Kategori *</label>
                        <select id="addPesertaKategori" required 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            <option value="">Pilih Kategori</option>
                            <option value="Magang">Magang</option>
                            <option value="PKL">PKL</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Pembimbing BPS *</label>
                        <select id="addPesertaPembimbingBPS" required 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            <option value="">Pilih Pembimbing BPS</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Guru/Dosen Asal</label>
                    <input type="text" id="addPesertaGuruDosenAsal" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                        <input type="email" id="addPesertaEmail" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">No. Telepon</label>
                        <input type="tel" id="addPesertaNoTelepon" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Mulai *</label>
                        <input type="date" id="addPesertaTanggalMulai" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Selesai *</label>
                        <input type="date" id="addPesertaTanggalSelesai" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Status *</label>
                    <select id="addPesertaStatus" required 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <option value="Aktif">Aktif</option>
                        <option value="Pending">Pending</option>
                        <option value="Nonaktif">Nonaktif</option>
                        <option value="Selesai">Selesai</option>
                    </select>
                </div>

                <div class="flex space-x-3 pt-4">
                    <button type="button" onclick="hideAddPesertaModal()" 
                            class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition-colors">
                        <i class="fas fa-times mr-2"></i>Batal
                    </button>
                    <button type="submit" 
                            class="flex-1 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition-colors">
                        <span id="addPesertaButtonText"><i class="fas fa-save mr-2"></i>Simpan</span>
                        <div id="addPesertaButtonLoading" class="loading hidden"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Peserta Modal -->
    <div id="viewPesertaModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-2xl mx-4 max-h-screen overflow-y-auto fade-in">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-user-graduate text-white text-2xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">Detail Peserta</h2>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-gray-50 p-4 rounded-lg">
                    <label class="block text-sm font-medium text-gray-600 mb-1">Nama Lengkap</label>
                    <p id="viewPesertaNamaLengkap" class="text-gray-800 font-medium">-</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <label class="block text-sm font-medium text-gray-600 mb-1">NIM/NISN</label>
                    <p id="viewPesertaNimNisn" class="text-gray-800 font-medium">-</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <label class="block text-sm font-medium text-gray-600 mb-1">Asal Sekolah/PT</label>
                    <p id="viewPesertaAsalSekolahPT" class="text-gray-800 font-medium">-</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <label class="block text-sm font-medium text-gray-600 mb-1">Jurusan</label>
                    <p id="viewPesertaJurusan" class="text-gray-800 font-medium">-</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <label class="block text-sm font-medium text-gray-600 mb-1">Kategori</label>
                    <p id="viewPesertaKategori" class="text-gray-800 font-medium">-</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <label class="block text-sm font-medium text-gray-600 mb-1">Pembimbing BPS</label>
                    <p id="viewPesertaPembimbingBPS" class="text-gray-800 font-medium">-</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <label class="block text-sm font-medium text-gray-600 mb-1">Guru/Dosen Asal</label>
                    <p id="viewPesertaGuruDosenAsal" class="text-gray-800 font-medium">-</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <label class="block text-sm font-medium text-gray-600 mb-1">Email</label>
                    <p id="viewPesertaEmail" class="text-gray-800 font-medium">-</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <label class="block text-sm font-medium text-gray-600 mb-1">No. Telepon</label>
                    <p id="viewPesertaNoTelepon" class="text-gray-800 font-medium">-</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <label class="block text-sm font-medium text-gray-600 mb-1">Tanggal Mulai</label>
                    <p id="viewPesertaTanggalMulai" class="text-gray-800 font-medium">-</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <label class="block text-sm font-medium text-gray-600 mb-1">Tanggal Selesai</label>
                    <p id="viewPesertaTanggalSelesai" class="text-gray-800 font-medium">-</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <label class="block text-sm font-medium text-gray-600 mb-1">Status</label>
                    <p id="viewPesertaStatus" class="text-gray-800 font-medium">-</p>
                </div>
            </div>

            <div class="mt-6">
                <button onclick="hideViewPesertaModal()" 
                        class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition-colors">
                    <i class="fas fa-check mr-2"></i>Tutup
                </button>
            </div>
        </div>
    </div>

    <!-- Add Tugas Modal -->
    <div id="addTugasModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-2xl mx-4 max-h-screen overflow-y-auto fade-in">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-yellow-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-tasks text-white text-2xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">Tambah Tugas Baru</h2>
                <p class="text-gray-600 mt-2">Buat tugas untuk peserta bimbingan</p>
            </div>

            <form id="addTugasForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Judul Tugas *</label>
                    <input type="text" id="addTugasJudul" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                           placeholder="Masukkan judul tugas">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi Tugas</label>
                    <textarea id="addTugasDeskripsi" rows="3"
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                              placeholder="Jelaskan detail tugas yang harus dikerjakan"></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Assign To *</label>
                        <select id="addTugasAssignTo" required 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                            <option value="">Pilih Peserta</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Deadline *</label>
                        <input type="date" id="addTugasDeadline" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Priority *</label>
                        <select id="addTugasPriority" required 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                            <option value="">Pilih Priority</option>
                            <option value="High">Penting</option>
                            <option value="Medium">Sedang</option>
                            <option value="Low">Biasa</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status *</label>
                        <select id="addTugasStatus" required 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                            <option value="Pending">Pending</option>
                            <option value="In Progress">Sedang Berjalan</option>
                            <option value="Completed">Selesai</option>
                        </select>
                    </div>
                </div>

                <div class="flex space-x-3 pt-4">
                    <button type="button" onclick="hideAddTugasModal()" 
                            class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition-colors">
                        <i class="fas fa-times mr-2"></i>Batal
                    </button>
                    <button type="submit" 
                            class="flex-1 bg-yellow-600 text-white py-3 rounded-lg hover:bg-yellow-700 transition-colors">
                        <span id="addTugasButtonText"><i class="fas fa-save mr-2"></i>Simpan</span>
                        <div id="addTugasButtonLoading" class="loading hidden"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="hidden">
        <!-- Sidebar -->
        <div id="sidebar" class="fixed left-0 top-0 h-full w-64 bg-white shadow-lg z-30 sidebar-transition flex flex-col">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-building text-white"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-gray-800">Dashboard BPS</h1>
                        <p class="text-xs text-gray-600">Magang & PKL</p>
                    </div>
                </div>
            </div>

            <nav class="mt-6 flex-1 overflow-y-auto pb-20">
                <div class="px-6 mb-4">
                    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Menu Utama</p>
                </div>
                <a href="#" onclick="showSection('dashboard-overview')" 
                   class="nav-item flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                    <i class="fas fa-tachometer-alt w-5"></i>
                    <span class="ml-3">Dashboard</span>
                </a>
                <a href="#" onclick="showSection('users-management')" 
                   class="nav-item flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                    <i class="fas fa-users w-5"></i>
                    <span class="ml-3">Manajemen User</span>
                </a>
                <a href="#" onclick="showSection('peserta-management')" 
                   class="nav-item flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                    <i class="fas fa-user-graduate w-5"></i>
                    <span class="ml-3">Data Peserta</span>
                </a>
                <a href="#" onclick="showSection('absensi-management')" 
                   class="nav-item flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                    <i class="fas fa-calendar-check w-5"></i>
                    <span class="ml-3">Absensi</span>
                </a>
                <a href="#" onclick="showSection('tugas-management')" 
                   class="nav-item flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                    <i class="fas fa-tasks w-5"></i>
                    <span class="ml-3">Tugas</span>
                </a>
                <a href="#" onclick="showSection('laporan-management')" 
                   class="nav-item flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                    <i class="fas fa-file-alt w-5"></i>
                    <span class="ml-3">Laporan</span>
                </a>
                <a href="#" onclick="showSection('surat-management')" 
                   class="nav-item flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                    <i class="fas fa-envelope w-5"></i>
                    <span class="ml-3">Surat</span>
                </a>
                <a href="#" onclick="showSection('sertifikat-management')" 
                   class="nav-item flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                    <i class="fas fa-certificate w-5"></i>
                    <span class="ml-3">Sertifikat</span>
                </a>
                
                <div class="px-6 mt-6 mb-4">
                    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Sistem</p>
                </div>
                <a href="#" onclick="showSection('dokumentasi-management')" 
                   class="nav-item flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                    <i class="fas fa-book w-5"></i>
                    <span class="ml-3">Dokumentasi</span>
                </a>
                <a href="#" onclick="showSection('admin-management')" 
                   class="nav-item flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                    <i class="fas fa-cog w-5"></i>
                    <span class="ml-3">Manajemen Admin</span>
                </a>
            </nav>

            <div class="absolute bottom-0 left-0 right-0 p-6 border-t border-gray-200">
                <div class="flex items-center space-x-3 mb-3">
                    <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-white text-sm"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-800 truncate" id="sidebarUserName">User</p>
                        <p class="text-xs text-gray-600" id="sidebarUserRole">Role</p>
                    </div>
                </div>
                <button onclick="logout()" 
                        class="w-full bg-red-50 text-red-600 py-2 rounded-lg hover:bg-red-100 transition-colors text-sm">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div id="mainContent" class="ml-64 content-transition">
            <!-- Header -->
            <header class="bg-white shadow-sm border-b border-gray-200 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <button onclick="toggleSidebar()" class="lg:hidden text-gray-600 hover:text-gray-800">
                            <i class="fas fa-bars text-xl"></i>
                        </button>
                        <div>
                            <h2 class="text-xl font-semibold text-gray-800" id="pageTitle">Dashboard</h2>
                            <p class="text-sm text-gray-600" id="pageSubtitle">Selamat datang di sistem manajemen magang & PKL</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-right">
                            <p class="text-sm font-medium text-gray-800" id="headerUserName">User</p>
                            <p class="text-xs text-gray-600" id="headerUserRole">Role</p>
                        </div>
                        <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                            <i class="fas fa-user text-white text-sm"></i>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Content Sections -->
            <main class="p-6">
                <!-- Dashboard Overview -->
                <div id="dashboard-overview" class="section">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">Total Users</p>
                                    <p class="text-2xl font-bold text-gray-800" id="totalUsers">0</p>
                                </div>
                                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-users text-blue-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">Peserta Aktif</p>
                                    <p class="text-2xl font-bold text-gray-800" id="totalPeserta">0</p>
                                </div>
                                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-user-graduate text-green-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">Tugas Aktif</p>
                                    <p class="text-2xl font-bold text-gray-800" id="totalTugas">0</p>
                                </div>
                                <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-tasks text-yellow-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600">Laporan</p>
                                    <p class="text-2xl font-bold text-gray-800" id="totalLaporan">0</p>
                                </div>
                                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-file-alt text-purple-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Aktivitas Terbaru</h3>
                            <div id="recentActivities" class="space-y-3">
                                <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                        <i class="fas fa-user-plus text-blue-600 text-sm"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm font-medium text-gray-800">User baru terdaftar</p>
                                        <p class="text-xs text-gray-600">2 menit yang lalu</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Quick Actions</h3>
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="showSection('users-management')" 
                                        class="p-4 bg-blue-50 hover:bg-blue-100 rounded-lg text-center transition-colors">
                                    <i class="fas fa-users text-blue-600 text-xl mb-2"></i>
                                    <p class="text-sm font-medium text-blue-600">Kelola User</p>
                                </button>
                                <button onclick="showSection('peserta-management')" 
                                        class="p-4 bg-green-50 hover:bg-green-100 rounded-lg text-center transition-colors">
                                    <i class="fas fa-user-graduate text-green-600 text-xl mb-2"></i>
                                    <p class="text-sm font-medium text-green-600">Data Peserta</p>
                                </button>
                                <button onclick="showSection('tugas-management')" 
                                        class="p-4 bg-yellow-50 hover:bg-yellow-100 rounded-lg text-center transition-colors">
                                    <i class="fas fa-tasks text-yellow-600 text-xl mb-2"></i>
                                    <p class="text-sm font-medium text-yellow-600">Kelola Tugas</p>
                                </button>
                                <button onclick="showSection('laporan-management')" 
                                        class="p-4 bg-purple-50 hover:bg-purple-100 rounded-lg text-center transition-colors">
                                    <i class="fas fa-file-alt text-purple-600 text-xl mb-2"></i>
                                    <p class="text-sm font-medium text-purple-600">Laporan</p>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Users Management -->
                <div id="users-management" class="section hidden">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                        <div class="p-6 border-b border-gray-200">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-semibold text-gray-800">Manajemen User</h3>
                                <button onclick="showAddUserModal()" 
                                        class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                    <i class="fas fa-plus mr-2"></i>Tambah User
                                </button>
                            </div>
                        </div>
                        <div class="p-6">
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr class="border-b border-gray-200">
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Nama</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Username</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Email</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Role</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Status</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Tanggal Daftar</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="usersTableBody">
                                        <tr>
                                            <td colspan="7" class="text-center py-8 text-gray-500">
                                                <div class="loading mx-auto mb-2"></div>
                                                Memuat data...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Peserta Management -->
                <div id="peserta-management" class="section hidden">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                        <div class="p-6 border-b border-gray-200">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-semibold text-gray-800">Data Peserta Magang & PKL</h3>
                                <button onclick="showAddPesertaModal()" 
                                        class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                    <i class="fas fa-plus mr-2"></i>Tambah Peserta
                                </button>
                            </div>
                        </div>
                        <div class="p-6">
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr class="border-b border-gray-200">
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">ID</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Nama Lengkap</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">NIM/NISN</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Asal Sekolah/PT</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Jurusan</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Kategori</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Pembimbing BPS</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Guru/Dosen Asal</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Email</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">No. Telepon</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Tanggal Mulai</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Tanggal Selesai</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Status</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pesertaTableBody">
                                        <tr>
                                            <td colspan="14" class="text-center py-8 text-gray-500">
                                                <div class="loading mx-auto mb-2"></div>
                                                Memuat data...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Other sections (Absensi, Tugas, Laporan, etc.) -->
                <div id="absensi-management" class="section hidden">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                        <div class="p-6 border-b border-gray-200">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-semibold text-gray-800">Manajemen Absensi</h3>
                                <button onclick="showAddAbsensiModal()" 
                                        class="bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 transition-colors">
                                    <i class="fas fa-plus mr-2"></i>Input Absensi
                                </button>
                            </div>
                        </div>
                        <div class="p-6">
                            <div class="mb-4 flex space-x-4">
                                <input type="date" id="filterTanggalAbsensi" onchange="filterAbsensi()" 
                                       class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                                <select id="filterStatusAbsensi" onchange="filterAbsensi()" 
                                        class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                                    <option value="">Semua Status</option>
                                    <option value="Hadir">Hadir</option>
                                    <option value="Izin">Izin</option>
                                    <option value="Sakit">Sakit</option>
                                    <option value="Alpha">Alpha</option>
                                </select>
                                <input type="text" id="searchAbsensi" placeholder="Cari nama..." 
                                       onkeyup="searchAbsensi()"
                                       class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr class="border-b border-gray-200">
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Nama</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Tanggal</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Jam Masuk</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Jam Keluar</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Status</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Keterangan</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="absensiTableBody">
                                        <tr>
                                            <td colspan="7" class="text-center py-8 text-gray-500">
                                                <div class="loading mx-auto mb-2"></div>
                                                Memuat data absensi...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tugas-management" class="section hidden">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                        <div class="p-6 border-b border-gray-200">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-semibold text-gray-800">Manajemen Tugas</h3>
                                <button onclick="showAddTugasModal()" 
                                        class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition-colors">
                                    <i class="fas fa-plus mr-2"></i>Tambah Tugas
                                </button>
                            </div>
                        </div>
                        <div class="p-6">
                            <div class="mb-4 flex space-x-4">
                                <select id="filterStatusTugas" onchange="filterTugas()" 
                                        class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500">
                                    <option value="">Semua Status</option>
                                    <option value="Pending">Pending</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Overdue">Overdue</option>
                                </select>
                                <input type="text" id="searchTugas" placeholder="Cari tugas..." 
                                       onkeyup="searchTugas()"
                                       class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500">
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr class="border-b border-gray-200">
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Judul Tugas</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Assigned To</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Deadline</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Priority</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Status</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tugasTableBody">
                                        <tr>
                                            <td colspan="6" class="text-center py-8 text-gray-500">
                                                <div class="loading mx-auto mb-2"></div>
                                                Memuat data tugas...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="laporan-management" class="section hidden">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                        <div class="p-6 border-b border-gray-200">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-semibold text-gray-800">Manajemen Laporan</h3>
                                <button onclick="showAddLaporanModal()" 
                                        class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                                    <i class="fas fa-plus mr-2"></i>Tambah Laporan
                                </button>
                            </div>
                        </div>
                        <div class="p-6">
                            <div class="mb-4 flex space-x-4">
                                <select id="filterStatusLaporan" onchange="filterLaporan()" 
                                        class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                    <option value="">Semua Status</option>
                                    <option value="Draft">Draft</option>
                                    <option value="Submitted">Submitted</option>
                                    <option value="Reviewed">Reviewed</option>
                                    <option value="Approved">Approved</option>
                                </select>
                                <input type="text" id="searchLaporan" placeholder="Cari laporan..." 
                                       onkeyup="searchLaporan()"
                                       class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr class="border-b border-gray-200">
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Judul Laporan</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Penulis</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Tanggal</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Status</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">File</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="laporanTableBody">
                                        <tr>
                                            <td colspan="6" class="text-center py-8 text-gray-500">
                                                <div class="loading mx-auto mb-2"></div>
                                                Memuat data laporan...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="surat-management" class="section hidden">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                        <div class="p-6 border-b border-gray-200">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-semibold text-gray-800">Manajemen Surat</h3>
                                <button onclick="showAddSuratModal()" 
                                        class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                                    <i class="fas fa-plus mr-2"></i>Buat Surat
                                </button>
                            </div>
                        </div>
                        <div class="p-6">
                            <div class="mb-4 flex space-x-4">
                                <select id="filterJenisSurat" onchange="filterSurat()" 
                                        class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <option value="">Semua Jenis</option>
                                    <option value="Surat Masuk">Surat Masuk</option>
                                    <option value="Surat Keluar">Surat Keluar</option>
                                    <option value="Surat Tugas">Surat Tugas</option>
                                    <option value="Surat Keterangan">Surat Keterangan</option>
                                </select>
                                <input type="text" id="searchSurat" placeholder="Cari surat..." 
                                       onkeyup="searchSurat()"
                                       class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr class="border-b border-gray-200">
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">No. Surat</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Perihal</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Jenis</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Tanggal</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Status</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="suratTableBody">
                                        <tr>
                                            <td colspan="6" class="text-center py-8 text-gray-500">
                                                <div class="loading mx-auto mb-2"></div>
                                                Memuat data surat...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="sertifikat-management" class="section hidden">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                        <div class="p-6 border-b border-gray-200">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-semibold text-gray-800">Manajemen Sertifikat</h3>
                                <button onclick="showAddSertifikatModal()" 
                                        class="bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 transition-colors">
                                    <i class="fas fa-plus mr-2"></i>Generate Sertifikat
                                </button>
                            </div>
                        </div>
                        <div class="p-6">
                            <div class="mb-4 flex space-x-4">
                                <select id="filterStatusSertifikat" onchange="filterSertifikat()" 
                                        class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                                    <option value="">Semua Status</option>
                                    <option value="Draft">Draft</option>
                                    <option value="Generated">Generated</option>
                                    <option value="Issued">Issued</option>
                                    <option value="Delivered">Delivered</option>
                                </select>
                                <input type="text" id="searchSertifikat" placeholder="Cari sertifikat..." 
                                       onkeyup="searchSertifikat()"
                                       class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr class="border-b border-gray-200">
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">No. Sertifikat</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Nama Penerima</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Program</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Tanggal</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Status</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="sertifikatTableBody">
                                        <tr>
                                            <td colspan="6" class="text-center py-8 text-gray-500">
                                                <div class="loading mx-auto mb-2"></div>
                                                Memuat data sertifikat...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="dokumentasi-management" class="section hidden">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Dokumentasi Sistem</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="bg-blue-50 p-6 rounded-lg">
                                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mb-4">
                                    <i class="fas fa-book text-blue-600 text-xl"></i>
                                </div>
                                <h4 class="font-semibold text-gray-800 mb-2">Panduan User</h4>
                                <p class="text-sm text-gray-600 mb-4">Panduan lengkap penggunaan sistem untuk semua role</p>
                                <button class="text-blue-600 hover:text-blue-700 text-sm font-medium">
                                    <i class="fas fa-download mr-1"></i>Download PDF
                                </button>
                            </div>
                            <div class="bg-green-50 p-6 rounded-lg">
                                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mb-4">
                                    <i class="fas fa-code text-green-600 text-xl"></i>
                                </div>
                                <h4 class="font-semibold text-gray-800 mb-2">API Documentation</h4>
                                <p class="text-sm text-gray-600 mb-4">Dokumentasi API untuk integrasi sistem</p>
                                <button class="text-green-600 hover:text-green-700 text-sm font-medium">
                                    <i class="fas fa-external-link-alt mr-1"></i>Lihat Online
                                </button>
                            </div>
                            <div class="bg-yellow-50 p-6 rounded-lg">
                                <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center mb-4">
                                    <i class="fas fa-video text-yellow-600 text-xl"></i>
                                </div>
                                <h4 class="font-semibold text-gray-800 mb-2">Video Tutorial</h4>
                                <p class="text-sm text-gray-600 mb-4">Tutorial video penggunaan sistem</p>
                                <button class="text-yellow-600 hover:text-yellow-700 text-sm font-medium">
                                    <i class="fas fa-play mr-1"></i>Tonton Video
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="admin-management" class="section hidden">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                        <div class="p-6 border-b border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-800">Manajemen Admin</h3>
                            <p class="text-sm text-gray-600 mt-1">Kelola pengaturan sistem dan hak akses admin</p>
                        </div>
                        <div class="p-6">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div class="space-y-4">
                                    <h4 class="font-medium text-gray-800">Pengaturan Sistem</h4>
                                    <div class="space-y-3">
                                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                            <div>
                                                <p class="font-medium text-gray-800">Backup Otomatis</p>
                                                <p class="text-sm text-gray-600">Backup data setiap hari</p>
                                            </div>
                                            <label class="relative inline-flex items-center cursor-pointer">
                                                <input type="checkbox" class="sr-only peer" checked>
                                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                            </label>
                                        </div>
                                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                            <div>
                                                <p class="font-medium text-gray-800">Notifikasi Email</p>
                                                <p class="text-sm text-gray-600">Kirim notifikasi ke admin</p>
                                            </div>
                                            <label class="relative inline-flex items-center cursor-pointer">
                                                <input type="checkbox" class="sr-only peer" checked>
                                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="space-y-4">
                                    <h4 class="font-medium text-gray-800">Statistik Sistem</h4>
                                    <div class="space-y-3">
                                        <div class="p-3 bg-blue-50 rounded-lg">
                                            <p class="text-sm text-blue-600 font-medium">Total Login Hari Ini</p>
                                            <p class="text-2xl font-bold text-blue-800">24</p>
                                        </div>
                                        <div class="p-3 bg-green-50 rounded-lg">
                                            <p class="text-sm text-green-600 font-medium">Data Tersimpan</p>
                                            <p class="text-2xl font-bold text-green-800">1,234</p>
                                        </div>
                                        <div class="p-3 bg-yellow-50 rounded-lg">
                                            <p class="text-sm text-yellow-600 font-medium">Backup Terakhir</p>
                                            <p class="text-sm font-medium text-yellow-800">2 jam yang lalu</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // API Configuration - CONNECTED TO YOUR GOOGLE SHEET
        const API_BASE_URL = 'https://script.google.com/macros/s/AKfycby6XBZ4vRxDJr6GreQR4vjXEJVaevdwp4TPka_HBnyDA8Ac7p6nOt8EuKE9M4yJflxp9Q/exec';
        const SHEET_ID = '1_cwHI_qiUCFXSGAbdM89H-QuH-fdDcEE0oTNdZEj94k';

        // Global State
        let currentUser = null;
        let sidebarCollapsed = false;

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Dashboard initialized');
            console.log('🔗 API URL:', API_BASE_URL);
            
            // Test API connection
            testAPIConnection();
            
            // Setup event listeners
            setupEventListeners();
        });

        // API Functions
        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                showLoading(true);
                
                let url = API_BASE_URL;
                let config = {
                    method: method,
                    mode: 'cors',
                    cache: 'no-cache'
                };

                // For Google Apps Script, handle GET and POST differently
                if (method === 'POST' && data) {
                    // For POST requests, send data in body as form data
                    const formData = new FormData();
                    Object.keys(data).forEach(key => {
                        formData.append(key, data[key]);
                    });
                    config.body = formData;
                } else if (data) {
                    // For GET requests, append as URL parameters
                    const params = new URLSearchParams(data);
                    url += '?' + params.toString();
                }

                console.log('📡 API Call:', method, url, data);

                const response = await fetch(url, config);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                console.log('📥 API Response:', result);
                
                showLoading(false);
                return result;
                
            } catch (error) {
                console.error('❌ API Error:', error);
                showLoading(false);
                showNotification('Error koneksi ke server: ' + error.message, 'error');
                return { success: false, message: error.message };
            }
        }

        async function testAPIConnection() {
            try {
                console.log('🔍 Testing API connection...');
                const result = await apiCall('', 'GET', { action: 'test' });
                
                if (result.success) {
                    console.log('✅ API connection successful');
                    showNotification('Koneksi ke server berhasil!', 'success');
                } else {
                    console.log('❌ API connection failed:', result);
                    showNotification('Gagal terhubung ke server', 'error');
                }
            } catch (error) {
                console.error('❌ API test failed:', error);
                showNotification('Error testing API: ' + error.message, 'error');
            }
        }

        // Authentication Functions
        async function login(username, password) {
            try {
                console.log('🔐 Attempting login for:', username);
                
                // Send login request to API
                const loginResult = await apiCall('', 'GET', { 
                    action: 'login',
                    username: username,
                    password: password
                });
                
                console.log('📥 Login API Response:', loginResult);
                
                // Check if login was successful
                if (loginResult.success) {
                    // If API returns user data, use it
                    if (loginResult.user) {
                        currentUser = {
                            id: loginResult.user.ID || loginResult.user.id,
                            username: loginResult.user.Username || loginResult.user.username || username,
                            namaLengkap: loginResult.user['Nama Lengkap'] || loginResult.user.namaLengkap || username,
                            email: loginResult.user.Email || loginResult.user.email,
                            role: loginResult.user.Role || loginResult.user.role || 'User',
                            status: loginResult.user.Status || loginResult.user.status || 'Aktif'
                        };
                    } else {
                        // Fallback: create user object from username
                        currentUser = {
                            id: Date.now().toString(),
                            username: username,
                            namaLengkap: username,
                            email: username + '@bps.go.id',
                            role: 'User',
                            status: 'Aktif'
                        };
                    }
                    
                    console.log('✅ Login successful:', currentUser);
                    
                    // Update UI with user info
                    updateUserInfo(currentUser);
                    
                    // Show success notification first
                    showNotification(`Selamat datang, ${currentUser.namaLengkap}!`, 'success');
                    
                    // Wait a moment then show dashboard
                    setTimeout(() => {
                        hideLoginModal();
                        showDashboard();
                        loadDashboardData();
                    }, 1000);
                    
                    return true;
                    
                } else {
                    // Login failed
                    console.log('❌ Login failed:', loginResult.message);
                    
                    if (loginResult.message && loginResult.message.includes('Authorization successful')) {
                        // Special case: API says authorization successful but no user data
                        // This means login worked but we need to handle it differently
                        currentUser = {
                            id: Date.now().toString(),
                            username: username,
                            namaLengkap: username,
                            email: username + '@bps.go.id',
                            role: 'User',
                            status: 'Aktif'
                        };
                        
                        console.log('✅ Authorization successful, proceeding with login:', currentUser);
                        
                        updateUserInfo(currentUser);
                        showNotification('Login berhasil!', 'success');
                        
                        setTimeout(() => {
                            hideLoginModal();
                            showDashboard();
                            loadDashboardData();
                        }, 1000);
                        
                        return true;
                    } else {
                        showNotification(loginResult.message || 'Login gagal', 'error');
                        return false;
                    }
                }
                
            } catch (error) {
                console.error('❌ Login error:', error);
                
                // If there's a connection error but we got "Authorization successful" message
                if (error.message && error.message.includes('Authorization successful')) {
                    currentUser = {
                        id: Date.now().toString(),
                        username: username,
                        namaLengkap: username,
                        email: username + '@bps.go.id',
                        role: 'User',
                        status: 'Aktif'
                    };
                    
                    updateUserInfo(currentUser);
                    showNotification('Login berhasil!', 'success');
                    
                    setTimeout(() => {
                        hideLoginModal();
                        showDashboard();
                        loadDashboardData();
                    }, 1000);
                    
                    return true;
                } else {
                    showNotification('Error saat login: ' + error.message, 'error');
                    return false;
                }
            }
        }

        async function register(userData) {
            try {
                console.log('📝 Registering new user:', userData);
                
                const result = await apiCall('', 'POST', {
                    action: 'registerUser',
                    sheetId: SHEET_ID,
                    sheetName: 'ADMIN',
                    namaLengkap: userData.namaLengkap,
                    username: userData.username,
                    email: userData.email,
                    password: userData.password,
                    role: userData.role,
                    noTelepon: userData.noTelepon || '',
                    status: 'Pending', // Default status for new registrations
                    tanggalDaftar: new Date().toISOString().split('T')[0]
                });

                if (result.success) {
                    showNotification('Pendaftaran berhasil! Menunggu persetujuan admin.', 'success');
                    hideRegisterModal();
                    return true;
                } else {
                    showNotification(result.message || 'Gagal mendaftar', 'error');
                    return false;
                }
            } catch (error) {
                console.error('❌ Registration error:', error);
                showNotification('Error saat mendaftar: ' + error.message, 'error');
                return false;
            }
        }

        async function initializeAdmin() {
            showNotification('Fitur inisialisasi admin tidak tersedia. Gunakan akun yang sudah ada.', 'info');
        }

        // Data Loading Functions with Caching
        let dataCache = {
            users: null,
            peserta: null,
            absensi: null,
            tugas: null,
            laporan: null,
            surat: null,
            sertifikat: null,
            lastUpdate: null
        };

        // Available sheet names in your Google Sheet
        const SHEET_NAMES = {
            ADMIN: 'ADMIN',
            PESERTA: 'PESERTA', 
            ABSENSI: 'ABSENSI',
            TUGAS: 'TUGAS',
            LAPORAN: 'LAPORAN',
            SURAT: 'SURAT',
            SERTIFIKAT: 'SERTIFIKAT'
        };

        // Role-based access control
        function hasAccess(requiredRole) {
            if (!currentUser) return false;
            
            const userRole = currentUser.role;
            const roleHierarchy = {
                'Admin': ['Admin', 'Pembimbing BPS', 'Peserta Magang', 'Peserta PKL'],
                'Pembimbing BPS': ['Pembimbing BPS', 'Peserta Magang', 'Peserta PKL'],
                'Peserta Magang': ['Peserta Magang'],
                'Peserta PKL': ['Peserta PKL']
            };
            
            return roleHierarchy[userRole]?.includes(requiredRole) || false;
        }

        // Get pembimbing list for dropdown
        async function getPembimbingList() {
            try {
                const users = dataCache.users || await loadUsers();
                return users.filter(user => user.Role === 'Pembimbing BPS' && user.Status === 'Aktif');
            } catch (error) {
                console.error('Error getting pembimbing list:', error);
                return [];
            }
        }

        // Get peserta under current pembimbing
        function getPesertaByPembimbing(pembimbingName) {
            const peserta = dataCache.peserta || [];
            return peserta.filter(p => p['Pembimbing BPS'] === pembimbingName && p.Status === 'Aktif');
        }

        // PESERTA Management Functions
        async function loadPeserta(forceRefresh = false) {
            try {
                // Check cache first
                if (!forceRefresh && dataCache.peserta && dataCache.lastUpdate && 
                    (Date.now() - dataCache.lastUpdate < 300000)) {
                    console.log('📋 Using cached peserta data');
                    displayPeserta(dataCache.peserta);
                    return dataCache.peserta;
                }

                console.log('👥 Loading peserta from PESERTA sheet...');
                
                // Show loading state immediately
                const tbody = document.getElementById('pesertaTableBody');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="13" class="text-center py-8 text-gray-500">
                                <div class="loading mx-auto mb-2"></div>
                                Memuat data peserta...
                            </td>
                        </tr>
                    `;
                }
                
                const result = await apiCall('', 'GET', { 
                    action: 'getData',
                    sheetName: 'PESERTA',
                    sheetId: SHEET_ID
                });

                if (result.success && result.data) {
                    console.log('✅ Peserta loaded from PESERTA sheet:', result.data.length);
                    dataCache.peserta = result.data;
                    dataCache.lastUpdate = Date.now();
                    displayPeserta(result.data);
                    return result.data;
                } else {
                    console.log('❌ Failed to load peserta:', result.message);
                    // Show sample data if API fails
                    const samplePeserta = getSamplePeserta();
                    displayPeserta(samplePeserta);
                    showNotification('Menampilkan data contoh peserta (koneksi API terbatas)', 'warning');
                    return samplePeserta;
                }
            } catch (error) {
                console.error('❌ Error loading peserta:', error);
                const samplePeserta = getSamplePeserta();
                displayPeserta(samplePeserta);
                showNotification('Menampilkan data contoh peserta (error koneksi)', 'warning');
                return samplePeserta;
            }
        }

        async function addPeserta(pesertaData) {
            try {
                console.log('➕ Adding new peserta to PESERTA sheet:', pesertaData);
                
                const result = await apiCall('', 'POST', {
                    action: 'addPeserta',
                    sheetId: SHEET_ID,
                    sheetName: 'PESERTA',
                    namaLengkap: pesertaData.namaLengkap,
                    nimNisn: pesertaData.nimNisn,
                    asalSekolahPT: pesertaData.asalSekolahPT,
                    jurusan: pesertaData.jurusan,
                    kategori: pesertaData.kategori,
                    pembimbingBPS: pesertaData.pembimbingBPS,
                    guruDosenAsal: pesertaData.guruDosenAsal,
                    email: pesertaData.email,
                    noTelepon: pesertaData.noTelepon,
                    tanggalMulai: pesertaData.tanggalMulai,
                    tanggalSelesai: pesertaData.tanggalSelesai,
                    status: pesertaData.status || 'Aktif'
                });

                if (result.success) {
                    showNotification('Peserta berhasil ditambahkan!', 'success');
                    hideAddPesertaModal();
                    loadPeserta(true); // Force refresh
                    return true;
                } else {
                    showNotification(result.message || 'Gagal menambah peserta', 'error');
                    return false;
                }
            } catch (error) {
                console.error('❌ Error adding peserta:', error);
                showNotification('Error menambah peserta: ' + error.message, 'error');
                return false;
            }
        }

        async function updatePeserta(pesertaId, pesertaData) {
            try {
                console.log('✏️ Updating peserta in PESERTA sheet:', pesertaId, pesertaData);
                
                const result = await apiCall('', 'POST', {
                    action: 'updatePeserta',
                    sheetId: SHEET_ID,
                    sheetName: 'PESERTA',
                    pesertaId: pesertaId,
                    namaLengkap: pesertaData.namaLengkap,
                    nimNisn: pesertaData.nimNisn,
                    asalSekolahPT: pesertaData.asalSekolahPT,
                    jurusan: pesertaData.jurusan,
                    kategori: pesertaData.kategori,
                    pembimbingBPS: pesertaData.pembimbingBPS,
                    guruDosenAsal: pesertaData.guruDosenAsal,
                    email: pesertaData.email,
                    noTelepon: pesertaData.noTelepon,
                    tanggalMulai: pesertaData.tanggalMulai,
                    tanggalSelesai: pesertaData.tanggalSelesai,
                    status: pesertaData.status
                });

                if (result.success) {
                    showNotification('Data peserta berhasil diupdate!', 'success');
                    loadPeserta(true); // Force refresh
                    return true;
                } else {
                    showNotification(result.message || 'Gagal update peserta', 'error');
                    return false;
                }
            } catch (error) {
                console.error('❌ Error updating peserta:', error);
                showNotification('Error update peserta: ' + error.message, 'error');
                return false;
            }
        }

        async function deletePeserta(pesertaId) {
            try {
                console.log('🗑️ Deleting peserta from PESERTA sheet:', pesertaId);
                
                const result = await apiCall('', 'POST', {
                    action: 'deletePeserta',
                    sheetId: SHEET_ID,
                    sheetName: 'PESERTA',
                    pesertaId: pesertaId
                });

                if (result.success) {
                    showNotification('Peserta berhasil dihapus!', 'success');
                    loadPeserta(true); // Force refresh
                    return true;
                } else {
                    showNotification(result.message || 'Gagal hapus peserta', 'error');
                    return false;
                }
            } catch (error) {
                console.error('❌ Error deleting peserta:', error);
                showNotification('Error hapus peserta: ' + error.message, 'error');
                return false;
            }
        }

        async function togglePesertaStatus(pesertaId) {
            try {
                const peserta = dataCache.peserta || [];
                const pesertaData = peserta.find(p => (p.ID || p._rowIndex) == pesertaId);
                
                if (!pesertaData) {
                    showNotification('Data peserta tidak ditemukan', 'error');
                    return;
                }

                const currentStatus = pesertaData.Status;
                const newStatus = currentStatus === 'Aktif' ? 'Nonaktif' : 'Aktif';
                const action = newStatus === 'Aktif' ? 'mengaktifkan' : 'menonaktifkan';

                if (!confirm(`Apakah Anda yakin ingin ${action} peserta ini?`)) {
                    return;
                }

                console.log(`🔄 Toggling peserta status: ${pesertaId} to ${newStatus}`);
                
                const result = await apiCall('', 'POST', {
                    action: 'updatePesertaStatus',
                    sheetId: SHEET_ID,
                    sheetName: 'PESERTA',
                    pesertaId: pesertaId,
                    status: newStatus
                });

                if (result.success) {
                    showNotification(`Peserta berhasil ${newStatus === 'Aktif' ? 'diaktifkan' : 'dinonaktifkan'}!`, 'success');
                    loadPeserta(true); // Force refresh
                } else {
                    showNotification(result.message || `Gagal ${action} peserta`, 'error');
                }
            } catch (error) {
                console.error('❌ Error toggling peserta status:', error);
                showNotification('Error mengubah status peserta: ' + error.message, 'error');
            }
        }

        // Enhanced Registration Function for Dual Sheet Posting
        async function registerPeserta(userData) {
            try {
                console.log('📝 Registering new peserta to both ADMIN and PESERTA sheets:', userData);
                
                // First, add to ADMIN sheet for login credentials
                const adminResult = await apiCall('', 'POST', {
                    action: 'registerUser',
                    sheetId: SHEET_ID,
                    sheetName: 'ADMIN',
                    namaLengkap: userData.namaLengkap,
                    username: userData.username,
                    email: userData.email,
                    password: userData.password,
                    role: userData.role,
                    noTelepon: userData.noTelepon || '',
                    status: 'Pending', // Default status for new registrations
                    tanggalDaftar: new Date().toISOString().split('T')[0]
                });

                if (!adminResult.success) {
                    showNotification(adminResult.message || 'Gagal mendaftar ke sistem admin', 'error');
                    return false;
                }

                // If user is peserta (Magang/PKL), also add to PESERTA sheet
                if (userData.role === 'Peserta Magang' || userData.role === 'Peserta PKL') {
                    const pesertaResult = await apiCall('', 'POST', {
                        action: 'addPeserta',
                        sheetId: SHEET_ID,
                        sheetName: 'PESERTA',
                        namaLengkap: userData.namaLengkap,
                        nimNisn: userData.nimNisn || '',
                        asalSekolahPT: userData.asalSekolahPT || '',
                        jurusan: userData.jurusan || '',
                        kategori: userData.role === 'Peserta Magang' ? 'Magang' : 'PKL',
                        pembimbingBPS: userData.pembimbingBPS || '',
                        guruDosenAsal: userData.guruDosenAsal || '',
                        email: userData.email,
                        noTelepon: userData.noTelepon || '',
                        tanggalMulai: userData.tanggalMulai || '',
                        tanggalSelesai: userData.tanggalSelesai || '',
                        status: 'Pending' // Will be activated when admin approves
                    });

                    if (!pesertaResult.success) {
                        showNotification('Akun terdaftar di sistem admin, namun gagal menambah data peserta. Silakan hubungi admin.', 'warning');
                    }
                }

                showNotification('Pendaftaran berhasil! Menunggu persetujuan admin.', 'success');
                return true;
                
            } catch (error) {
                console.error('❌ Registration error:', error);
                showNotification('Error saat mendaftar: ' + error.message, 'error');
                return false;
            }
        }

        async function loadUsers(forceRefresh = false) {
            try {
                // Check cache first (valid for 5 minutes)
                if (!forceRefresh && dataCache.users && dataCache.lastUpdate && 
                    (Date.now() - dataCache.lastUpdate < 300000)) {
                    console.log('📋 Using cached users data');
                    displayUsers(dataCache.users);
                    return dataCache.users;
                }

                console.log('👥 Loading users from ADMIN sheet...');
                
                // Show loading state immediately
                const tbody = document.getElementById('usersTableBody');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center py-8 text-gray-500">
                                <div class="loading mx-auto mb-2"></div>
                                Memuat data users...
                            </td>
                        </tr>
                    `;
                }
                
                const result = await apiCall('', 'GET', { 
                    action: 'getData',
                    sheetName: 'ADMIN',
                    sheetId: SHEET_ID
                });

                if (result.success && result.data) {
                    console.log('✅ Users loaded from ADMIN sheet:', result.data.length);
                    dataCache.users = result.data;
                    dataCache.lastUpdate = Date.now();
                    displayUsers(result.data);
                    return result.data;
                } else {
                    console.log('❌ Failed to load users:', result.message);
                    // Show sample data if API fails
                    const sampleUsers = [
                        {
                            _rowIndex: 1,
                            'Nama Lengkap': 'Admin BPS',
                            Username: 'admin',
                            Email: 'admin@bps.go.id',
                            Role: 'Admin',
                            Status: 'Aktif',
                            'Tanggal Daftar': '2024-01-01'
                        },
                        {
                            _rowIndex: 2,
                            'Nama Lengkap': 'User Pending',
                            Username: 'user1',
                            Email: 'user1@bps.go.id',
                            Role: 'Peserta Magang',
                            Status: 'Pending',
                            'Tanggal Daftar': '2024-01-15'
                        }
                    ];
                    displayUsers(sampleUsers);
                    showNotification('Menampilkan data contoh (koneksi API terbatas)', 'warning');
                    return sampleUsers;
                }
            } catch (error) {
                console.error('❌ Error loading users:', error);
                // Show sample data on error
                const sampleUsers = [
                    {
                        _rowIndex: 1,
                        'Nama Lengkap': 'Admin BPS',
                        Username: 'admin',
                        Email: 'admin@bps.go.id',
                        Role: 'Admin',
                        Status: 'Aktif',
                        'Tanggal Daftar': '2024-01-01'
                    }
                ];
                displayUsers(sampleUsers);
                showNotification('Menampilkan data contoh (error koneksi)', 'warning');
                return sampleUsers;
            }
        }

        async function loadPeserta(forceRefresh = false) {
            return await loadSheetData('peserta', SHEET_NAMES.PESERTA, displayPeserta, getSamplePeserta, forceRefresh);
        }

        async function loadAbsensi(forceRefresh = false) {
            return await loadSheetData('absensi', SHEET_NAMES.ABSENSI, displayAbsensi, getSampleAbsensi, forceRefresh);
        }

        async function loadTugas(forceRefresh = false) {
            try {
                // Check cache first
                if (!forceRefresh && dataCache.tugas && dataCache.lastUpdate && 
                    (Date.now() - dataCache.lastUpdate < 300000)) {
                    console.log('📋 Using cached tugas data');
                    displayTugas(dataCache.tugas);
                    return dataCache.tugas;
                }

                console.log('📊 Loading tugas from TUGAS sheet...');
                
                // Show loading state immediately
                const tbody = document.getElementById('tugasTableBody');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center py-8 text-gray-500">
                                <div class="loading mx-auto mb-2"></div>
                                Memuat data tugas...
                            </td>
                        </tr>
                    `;
                }
                
                const result = await apiCall('', 'GET', { 
                    action: 'getData',
                    sheetName: 'TUGAS',
                    sheetId: SHEET_ID
                });

                if (result.success && result.data) {
                    console.log('✅ Tugas loaded from TUGAS sheet:', result.data.length);
                    
                    // Filter tugas based on user role
                    let filteredTugas = result.data;
                    if (currentUser && currentUser.role === 'Pembimbing BPS') {
                        // Show only tugas assigned by this pembimbing
                        filteredTugas = result.data.filter(t => t['Pembimbing'] === currentUser.namaLengkap);
                    } else if (currentUser && (currentUser.role === 'Peserta Magang' || currentUser.role === 'Peserta PKL')) {
                        // Show only tugas assigned to this peserta
                        filteredTugas = result.data.filter(t => t['Assigned To'] === currentUser.namaLengkap);
                    }
                    
                    dataCache.tugas = filteredTugas;
                    dataCache.lastUpdate = Date.now();
                    displayTugas(filteredTugas);
                    return filteredTugas;
                } else {
                    console.log('❌ Failed to load tugas:', result.message);
                    const sampleTugas = getSampleTugas();
                    displayTugas(sampleTugas);
                    showNotification('Menampilkan data contoh tugas (koneksi API terbatas)', 'warning');
                    return sampleTugas;
                }
            } catch (error) {
                console.error('❌ Error loading tugas:', error);
                const sampleTugas = getSampleTugas();
                displayTugas(sampleTugas);
                showNotification('Menampilkan data contoh tugas (error koneksi)', 'warning');
                return sampleTugas;
            }
        }

        async function addTugas(tugasData) {
            try {
                console.log('➕ Adding new tugas to TUGAS sheet:', tugasData);
                
                const result = await apiCall('', 'POST', {
                    action: 'addTugas',
                    sheetId: SHEET_ID,
                    sheetName: 'TUGAS',
                    judulTugas: tugasData.judulTugas,
                    deskripsi: tugasData.deskripsi,
                    assignedTo: tugasData.assignedTo,
                    pembimbing: tugasData.pembimbing || currentUser.namaLengkap,
                    deadline: tugasData.deadline,
                    priority: tugasData.priority,
                    status: tugasData.status,
                    tanggalDibuat: new Date().toISOString().split('T')[0]
                });

                if (result.success) {
                    showNotification('Tugas berhasil ditambahkan!', 'success');
                    hideAddTugasModal();
                    loadTugas(true); // Force refresh
                    return true;
                } else {
                    showNotification(result.message || 'Gagal menambah tugas', 'error');
                    return false;
                }
            } catch (error) {
                console.error('❌ Error adding tugas:', error);
                showNotification('Error menambah tugas: ' + error.message, 'error');
                return false;
            }
        }

        async function updateTugas(tugasId, tugasData) {
            try {
                console.log('✏️ Updating tugas in TUGAS sheet:', tugasId, tugasData);
                
                const result = await apiCall('', 'POST', {
                    action: 'updateTugas',
                    sheetId: SHEET_ID,
                    sheetName: 'TUGAS',
                    tugasId: tugasId,
                    judulTugas: tugasData.judulTugas,
                    deskripsi: tugasData.deskripsi,
                    assignedTo: tugasData.assignedTo,
                    deadline: tugasData.deadline,
                    priority: tugasData.priority,
                    status: tugasData.status
                });

                if (result.success) {
                    showNotification('Tugas berhasil diupdate!', 'success');
                    loadTugas(true); // Force refresh
                    return true;
                } else {
                    showNotification(result.message || 'Gagal update tugas', 'error');
                    return false;
                }
            } catch (error) {
                console.error('❌ Error updating tugas:', error);
                showNotification('Error update tugas: ' + error.message, 'error');
                return false;
            }
        }

        async function deleteTugasAPI(tugasId) {
            try {
                console.log('🗑️ Deleting tugas from TUGAS sheet:', tugasId);
                
                const result = await apiCall('', 'POST', {
                    action: 'deleteTugas',
                    sheetId: SHEET_ID,
                    sheetName: 'TUGAS',
                    tugasId: tugasId
                });

                if (result.success) {
                    showNotification('Tugas berhasil dihapus!', 'success');
                    loadTugas(true); // Force refresh
                    return true;
                } else {
                    showNotification(result.message || 'Gagal hapus tugas', 'error');
                    return false;
                }
            } catch (error) {
                console.error('❌ Error deleting tugas:', error);
                showNotification('Error hapus tugas: ' + error.message, 'error');
                return false;
            }
        }

        async function loadLaporan(forceRefresh = false) {
            return await loadSheetData('laporan', SHEET_NAMES.LAPORAN, displayLaporan, getSampleLaporan, forceRefresh);
        }

        async function loadSurat(forceRefresh = false) {
            return await loadSheetData('surat', SHEET_NAMES.SURAT, displaySurat, getSampleSurat, forceRefresh);
        }

        async function loadSertifikat(forceRefresh = false) {
            return await loadSheetData('sertifikat', SHEET_NAMES.SERTIFIKAT, displaySertifikat, getSampleSertifikat, forceRefresh);
        }

        // Generic function to load sheet data
        async function loadSheetData(cacheKey, sheetName, displayFunction, sampleDataFunction, forceRefresh = false) {
            try {
                // Check cache first
                if (!forceRefresh && dataCache[cacheKey] && dataCache.lastUpdate && 
                    (Date.now() - dataCache.lastUpdate < 300000)) {
                    console.log(`📋 Using cached ${cacheKey} data`);
                    displayFunction(dataCache[cacheKey]);
                    return dataCache[cacheKey];
                }

                console.log(`📊 Loading ${cacheKey} from sheet: ${sheetName}...`);
                
                const result = await apiCall('', 'GET', { 
                    action: 'getData',
                    sheetName: sheetName,
                    sheetId: SHEET_ID
                });

                if (result.success && result.data) {
                    console.log(`✅ ${cacheKey} loaded:`, result.data.length);
                    dataCache[cacheKey] = result.data;
                    dataCache.lastUpdate = Date.now();
                    displayFunction(result.data);
                    return result.data;
                } else {
                    console.log(`❌ Failed to load ${cacheKey}:`, result.message);
                    const sampleData = sampleDataFunction();
                    displayFunction(sampleData);
                    showNotification(`Menampilkan data contoh ${cacheKey} (koneksi API terbatas)`, 'warning');
                    return sampleData;
                }
            } catch (error) {
                console.error(`❌ Error loading ${cacheKey}:`, error);
                const sampleData = sampleDataFunction();
                displayFunction(sampleData);
                showNotification(`Menampilkan data contoh ${cacheKey} (error koneksi)`, 'warning');
                return sampleData;
            }
        }

        // Sample data functions
        function getSamplePeserta() {
            return [
                {
                    _rowIndex: 1,
                    'Nama Lengkap': 'Ahmad Rizki Pratama',
                    'NIM/NISN': '12345678',
                    'Asal Sekolah/PT': 'Universitas Indonesia',
                    Kategori: 'Magang',
                    Status: 'Aktif',
                    'Tanggal Mulai': '2024-01-15',
                    'Tanggal Selesai': '2024-03-15'
                },
                {
                    _rowIndex: 2,
                    'Nama Lengkap': 'Siti Nurhaliza',
                    'NIM/NISN': '87654321',
                    'Asal Sekolah/PT': 'SMK Negeri 1 Jakarta',
                    Kategori: 'PKL',
                    Status: 'Aktif',
                    'Tanggal Mulai': '2024-02-01',
                    'Tanggal Selesai': '2024-04-01'
                }
            ];
        }

        function getSampleAbsensi() {
            return [
                {
                    _rowIndex: 1,
                    'Nama': 'Ahmad Rizki Pratama',
                    'Tanggal': '2024-01-15',
                    'Jam Masuk': '08:00',
                    'Jam Keluar': '16:00',
                    'Status': 'Hadir',
                    'Keterangan': 'Tepat waktu'
                },
                {
                    _rowIndex: 2,
                    'Nama': 'Siti Nurhaliza',
                    'Tanggal': '2024-01-15',
                    'Jam Masuk': '08:15',
                    'Jam Keluar': '16:00',
                    'Status': 'Hadir',
                    'Keterangan': 'Terlambat 15 menit'
                }
            ];
        }

        function getSampleTugas() {
            return [
                {
                    _rowIndex: 1,
                    'Judul Tugas': 'Analisis Data Statistik',
                    'Assigned To': 'Ahmad Rizki Pratama',
                    'Deadline': '2024-02-01',
                    'Priority': 'High',
                    'Status': 'In Progress',
                    'Deskripsi': 'Melakukan analisis data statistik untuk laporan bulanan'
                },
                {
                    _rowIndex: 2,
                    'Judul Tugas': 'Pembuatan Laporan PKL',
                    'Assigned To': 'Siti Nurhaliza',
                    'Deadline': '2024-01-30',
                    'Priority': 'Medium',
                    'Status': 'Pending',
                    'Deskripsi': 'Menyusun laporan kegiatan PKL'
                }
            ];
        }

        function getSampleLaporan() {
            return [
                {
                    _rowIndex: 1,
                    'Judul Laporan': 'Laporan Magang Januari 2024',
                    'Penulis': 'Ahmad Rizki Pratama',
                    'Tanggal': '2024-01-31',
                    'Status': 'Submitted',
                    'File': 'laporan_magang_jan2024.pdf',
                    'Keterangan': 'Laporan kegiatan magang bulan Januari'
                },
                {
                    _rowIndex: 2,
                    'Judul Laporan': 'Laporan PKL Semester 1',
                    'Penulis': 'Siti Nurhaliza',
                    'Tanggal': '2024-01-28',
                    'Status': 'Draft',
                    'File': 'laporan_pkl_sem1.pdf',
                    'Keterangan': 'Laporan kegiatan PKL semester 1'
                }
            ];
        }

        function getSampleSurat() {
            return [
                {
                    _rowIndex: 1,
                    'No. Surat': 'ST/001/BPS/2024',
                    'Perihal': 'Surat Tugas Magang',
                    'Jenis': 'Surat Tugas',
                    'Tanggal': '2024-01-15',
                    'Status': 'Issued',
                    'Penerima': 'Ahmad Rizki Pratama'
                },
                {
                    _rowIndex: 2,
                    'No. Surat': 'SK/002/BPS/2024',
                    'Perihal': 'Surat Keterangan PKL',
                    'Jenis': 'Surat Keterangan',
                    'Tanggal': '2024-01-20',
                    'Status': 'Draft',
                    'Penerima': 'Siti Nurhaliza'
                }
            ];
        }

        function getSampleSertifikat() {
            return [
                {
                    _rowIndex: 1,
                    'No. Sertifikat': 'CERT/001/BPS/2024',
                    'Nama Penerima': 'Ahmad Rizki Pratama',
                    'Program': 'Magang Statistik',
                    'Tanggal': '2024-03-15',
                    'Status': 'Generated',
                    'Durasi': '2 Bulan'
                },
                {
                    _rowIndex: 2,
                    'No. Sertifikat': 'CERT/002/BPS/2024',
                    'Nama Penerima': 'Siti Nurhaliza',
                    'Program': 'PKL Data Analysis',
                    'Tanggal': '2024-04-01',
                    'Status': 'Draft',
                    'Durasi': '3 Bulan'
                }
            ];
        }

        async function loadDashboardData() {
            try {
                console.log('📊 Loading dashboard data...');
                
                // Set initial values immediately
                document.getElementById('totalUsers').textContent = '...';
                document.getElementById('totalPeserta').textContent = '...';
                document.getElementById('totalTugas').textContent = '12';
                document.getElementById('totalLaporan').textContent = '8';
                
                // Load data in parallel for better performance
                const [users, peserta] = await Promise.all([
                    loadUsers().catch(() => []),
                    loadPeserta().catch(() => [])
                ]);
                
                // Update dashboard statistics
                document.getElementById('totalUsers').textContent = users.length || '0';
                document.getElementById('totalPeserta').textContent = peserta.length || '0';
                
                // Update recent activities
                updateRecentActivities();
                
                console.log('✅ Dashboard data loaded successfully');
                
            } catch (error) {
                console.error('❌ Error loading dashboard data:', error);
                // Set fallback values
                document.getElementById('totalUsers').textContent = '2';
                document.getElementById('totalPeserta').textContent = '5';
            }
        }

        function updateRecentActivities() {
            const activitiesContainer = document.getElementById('recentActivities');
            const activities = [
                {
                    icon: 'fas fa-user-plus',
                    iconColor: 'text-blue-600',
                    bgColor: 'bg-blue-100',
                    text: `${currentUser?.namaLengkap || 'User'} login ke sistem`,
                    time: 'Baru saja'
                },
                {
                    icon: 'fas fa-file-alt',
                    iconColor: 'text-green-600',
                    bgColor: 'bg-green-100',
                    text: 'Laporan baru diterima',
                    time: '5 menit yang lalu'
                },
                {
                    icon: 'fas fa-tasks',
                    iconColor: 'text-yellow-600',
                    bgColor: 'bg-yellow-100',
                    text: 'Tugas baru ditambahkan',
                    time: '15 menit yang lalu'
                }
            ];

            activitiesContainer.innerHTML = activities.map(activity => `
                <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                    <div class="w-8 h-8 ${activity.bgColor} rounded-full flex items-center justify-center">
                        <i class="${activity.icon} ${activity.iconColor} text-sm"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-800">${activity.text}</p>
                        <p class="text-xs text-gray-600">${activity.time}</p>
                    </div>
                </div>
            `).join('');
        }

        // Display Functions
        function displayAbsensi(absensi) {
            const tbody = document.getElementById('absensiTableBody');
            
            if (!absensi || absensi.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-8 text-gray-500">
                            <i class="fas fa-calendar-check text-4xl mb-2 opacity-50"></i>
                            <p>Belum ada data absensi</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = absensi.map(a => `
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="py-3 px-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-teal-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-user text-teal-600 text-sm"></i>
                            </div>
                            <span class="font-medium text-gray-800">${a.Nama || 'N/A'}</span>
                        </div>
                    </td>
                    <td class="py-3 px-4 text-gray-600">${a.Tanggal || 'N/A'}</td>
                    <td class="py-3 px-4 text-gray-600">${a['Jam Masuk'] || 'N/A'}</td>
                    <td class="py-3 px-4 text-gray-600">${a['Jam Keluar'] || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${getAbsensiBadgeClass(a.Status)}">
                            ${a.Status || 'N/A'}
                        </span>
                    </td>
                    <td class="py-3 px-4 text-gray-600">${a.Keterangan || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <div class="flex space-x-2">
                            <button onclick="editAbsensi('${a._rowIndex}')" 
                                    class="text-blue-600 hover:text-blue-800 text-sm">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteAbsensi('${a._rowIndex}')" 
                                    class="text-red-600 hover:text-red-800 text-sm">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function displayTugas(tugas) {
            const tbody = document.getElementById('tugasTableBody');
            
            if (!tugas || tugas.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-8 text-gray-500">
                            <i class="fas fa-tasks text-4xl mb-2 opacity-50"></i>
                            <p>Belum ada data tugas</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = tugas.map(t => {
                const tugasId = t.ID || t._rowIndex;
                const canEdit = currentUser && (currentUser.role === 'Admin' || 
                    (currentUser.role === 'Pembimbing BPS' && t['Pembimbing'] === currentUser.namaLengkap) ||
                    (currentUser.role === 'Peserta Magang' || currentUser.role === 'Peserta PKL') && t['Assigned To'] === currentUser.namaLengkap);
                
                return `
                <tr id="tugasRow_${tugasId}" class="border-b border-gray-100 hover:bg-gray-50" data-tugas-id="${tugasId}">
                    <td class="py-3 px-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-tasks text-yellow-600 text-sm"></i>
                            </div>
                            <div class="editable-field" data-field="judulTugas">
                                <span class="display-value font-medium text-gray-800">${t['Judul Tugas'] || 'N/A'}</span>
                                <input type="text" class="edit-input hidden w-full px-2 py-1 border border-gray-300 rounded text-sm font-medium" 
                                       value="${t['Judul Tugas'] || ''}">
                            </div>
                        </div>
                    </td>
                    <td class="py-3 px-4">
                        <div class="editable-field" data-field="assignedTo">
                            <span class="display-value text-gray-600">${t['Assigned To'] || 'N/A'}</span>
                            <select class="edit-input hidden w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                <option value="">Pilih Peserta</option>
                            </select>
                        </div>
                    </td>
                    <td class="py-3 px-4">
                        <div class="editable-field" data-field="deadline">
                            <span class="display-value text-gray-600">${t.Deadline || 'N/A'}</span>
                            <input type="date" class="edit-input hidden w-full px-2 py-1 border border-gray-300 rounded text-sm" 
                                   value="${t.Deadline || ''}">
                        </div>
                    </td>
                    <td class="py-3 px-4">
                        <div class="editable-field" data-field="priority">
                            <span class="display-value px-2 py-1 text-xs font-medium rounded-full ${getPriorityBadgeClass(t.Priority)}">
                                ${t.Priority || 'N/A'}
                            </span>
                            <select class="edit-input hidden w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                <option value="High" ${t.Priority === 'High' ? 'selected' : ''}>Penting</option>
                                <option value="Medium" ${t.Priority === 'Medium' ? 'selected' : ''}>Sedang</option>
                                <option value="Low" ${t.Priority === 'Low' ? 'selected' : ''}>Biasa</option>
                            </select>
                        </div>
                    </td>
                    <td class="py-3 px-4">
                        <div class="editable-field" data-field="status">
                            <span class="display-value px-2 py-1 text-xs font-medium rounded-full ${getTugasStatusBadgeClass(t.Status)}">
                                ${t.Status || 'N/A'}
                            </span>
                            <select class="edit-input hidden w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                <option value="Pending" ${t.Status === 'Pending' ? 'selected' : ''}>Pending</option>
                                <option value="In Progress" ${t.Status === 'In Progress' ? 'selected' : ''}>Sedang Berjalan</option>
                                <option value="Completed" ${t.Status === 'Completed' ? 'selected' : ''}>Selesai</option>
                            </select>
                        </div>
                    </td>
                    <td class="py-3 px-4">
                        <div class="flex space-x-2">
                            <button onclick="viewTugasDetail('${tugasId}')" 
                                    class="text-green-600 hover:text-green-800 text-sm" title="Lihat Detail">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${canEdit ? `
                                <button onclick="toggleTugasEditMode('${tugasId}')" 
                                        class="edit-toggle-btn text-blue-600 hover:text-blue-800 text-sm" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="submitTugasChanges('${tugasId}')" 
                                        class="submit-btn hidden text-green-600 hover:text-green-800 text-sm" title="Submit">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button onclick="cancelTugasEdit('${tugasId}')" 
                                        class="cancel-btn hidden text-gray-600 hover:text-gray-800 text-sm" title="Cancel">
                                    <i class="fas fa-times"></i>
                                </button>
                                <button onclick="deleteTugasConfirm('${tugasId}')" 
                                        class="delete-btn text-red-600 hover:text-red-800 text-sm" title="Hapus">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
        }

        function displayLaporan(laporan) {
            const tbody = document.getElementById('laporanTableBody');
            
            if (!laporan || laporan.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-8 text-gray-500">
                            <i class="fas fa-file-alt text-4xl mb-2 opacity-50"></i>
                            <p>Belum ada data laporan</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = laporan.map(l => `
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="py-3 px-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-file-alt text-purple-600 text-sm"></i>
                            </div>
                            <span class="font-medium text-gray-800">${l['Judul Laporan'] || 'N/A'}</span>
                        </div>
                    </td>
                    <td class="py-3 px-4 text-gray-600">${l.Penulis || 'N/A'}</td>
                    <td class="py-3 px-4 text-gray-600">${l.Tanggal || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${getLaporanStatusBadgeClass(l.Status)}">
                            ${l.Status || 'N/A'}
                        </span>
                    </td>
                    <td class="py-3 px-4">
                        ${l.File ? `<a href="#" class="text-blue-600 hover:text-blue-800 text-sm"><i class="fas fa-download mr-1"></i>${l.File}</a>` : 'N/A'}
                    </td>
                    <td class="py-3 px-4">
                        <div class="flex space-x-2">
                            <button onclick="editLaporan('${l._rowIndex}')" 
                                    class="text-blue-600 hover:text-blue-800 text-sm">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteLaporan('${l._rowIndex}')" 
                                    class="text-red-600 hover:text-red-800 text-sm">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button onclick="viewLaporan('${l._rowIndex}')" 
                                    class="text-green-600 hover:text-green-800 text-sm">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function displaySurat(surat) {
            const tbody = document.getElementById('suratTableBody');
            
            if (!surat || surat.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-8 text-gray-500">
                            <i class="fas fa-envelope text-4xl mb-2 opacity-50"></i>
                            <p>Belum ada data surat</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = surat.map(s => `
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="py-3 px-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-envelope text-indigo-600 text-sm"></i>
                            </div>
                            <span class="font-medium text-gray-800">${s['No. Surat'] || 'N/A'}</span>
                        </div>
                    </td>
                    <td class="py-3 px-4 text-gray-600">${s.Perihal || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${getJenisSuratBadgeClass(s.Jenis)}">
                            ${s.Jenis || 'N/A'}
                        </span>
                    </td>
                    <td class="py-3 px-4 text-gray-600">${s.Tanggal || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${getSuratStatusBadgeClass(s.Status)}">
                            ${s.Status || 'N/A'}
                        </span>
                    </td>
                    <td class="py-3 px-4">
                        <div class="flex space-x-2">
                            <button onclick="editSurat('${s._rowIndex}')" 
                                    class="text-blue-600 hover:text-blue-800 text-sm">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteSurat('${s._rowIndex}')" 
                                    class="text-red-600 hover:text-red-800 text-sm">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button onclick="printSurat('${s._rowIndex}')" 
                                    class="text-green-600 hover:text-green-800 text-sm">
                                <i class="fas fa-print"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function displaySertifikat(sertifikat) {
            const tbody = document.getElementById('sertifikatTableBody');
            
            if (!sertifikat || sertifikat.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-8 text-gray-500">
                            <i class="fas fa-certificate text-4xl mb-2 opacity-50"></i>
                            <p>Belum ada data sertifikat</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = sertifikat.map(s => `
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="py-3 px-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-emerald-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-certificate text-emerald-600 text-sm"></i>
                            </div>
                            <span class="font-medium text-gray-800">${s['No. Sertifikat'] || 'N/A'}</span>
                        </div>
                    </td>
                    <td class="py-3 px-4 text-gray-600">${s['Nama Penerima'] || 'N/A'}</td>
                    <td class="py-3 px-4 text-gray-600">${s.Program || 'N/A'}</td>
                    <td class="py-3 px-4 text-gray-600">${s.Tanggal || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${getSertifikatStatusBadgeClass(s.Status)}">
                            ${s.Status || 'N/A'}
                        </span>
                    </td>
                    <td class="py-3 px-4">
                        <div class="flex space-x-2">
                            <button onclick="editSertifikat('${s._rowIndex}')" 
                                    class="text-blue-600 hover:text-blue-800 text-sm">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteSertifikat('${s._rowIndex}')" 
                                    class="text-red-600 hover:text-red-800 text-sm">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button onclick="downloadSertifikat('${s._rowIndex}')" 
                                    class="text-green-600 hover:text-green-800 text-sm">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function displayUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            
            if (!users || users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-8 text-gray-500">
                            <i class="fas fa-users text-4xl mb-2 opacity-50"></i>
                            <p>Belum ada data user</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = users.map(user => {
                const userId = user.ID || user._rowIndex;
                const isPending = user.Status === 'Pending';
                
                return `
                <tr id="userRow_${userId}" class="border-b border-gray-100 hover:bg-gray-50 ${isPending ? 'bg-yellow-50' : ''}" data-user-id="${userId}">
                    <td class="py-3 px-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 ${isPending ? 'bg-yellow-100' : 'bg-blue-100'} rounded-full flex items-center justify-center">
                                <i class="fas fa-user ${isPending ? 'text-yellow-600' : 'text-blue-600'} text-sm"></i>
                            </div>
                            <div class="editable-field" data-field="namaLengkap">
                                <span class="display-value font-medium text-gray-800">${user['Nama Lengkap'] || user.namaLengkap || 'N/A'}</span>
                                <input type="text" class="edit-input hidden w-full px-2 py-1 border border-gray-300 rounded text-sm font-medium" 
                                       value="${user['Nama Lengkap'] || user.namaLengkap || ''}">
                            </div>
                        </div>
                    </td>
                    <td class="py-3 px-4">
                        <div class="editable-field" data-field="username">
                            <span class="display-value text-gray-600">${user.Username || 'N/A'}</span>
                            <input type="text" class="edit-input hidden w-full px-2 py-1 border border-gray-300 rounded text-sm" 
                                   value="${user.Username || ''}">
                        </div>
                    </td>
                    <td class="py-3 px-4">
                        <div class="editable-field" data-field="email">
                            <span class="display-value text-gray-600">${user.Email || 'N/A'}</span>
                            <input type="email" class="edit-input hidden w-full px-2 py-1 border border-gray-300 rounded text-sm" 
                                   value="${user.Email || ''}">
                        </div>
                    </td>
                    <td class="py-3 px-4">
                        <div class="editable-field" data-field="role">
                            <span class="display-value px-2 py-1 text-xs font-medium rounded-full ${getRoleBadgeClass(user.Role)}">
                                ${user.Role || 'N/A'}
                            </span>
                            <select class="edit-input hidden w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                <option value="Admin" ${user.Role === 'Admin' ? 'selected' : ''}>Admin</option>
                                <option value="Pembimbing BPS" ${user.Role === 'Pembimbing BPS' ? 'selected' : ''}>Pembimbing BPS</option>
                                <option value="Peserta Magang" ${user.Role === 'Peserta Magang' ? 'selected' : ''}>Peserta Magang</option>
                                <option value="Peserta PKL" ${user.Role === 'Peserta PKL' ? 'selected' : ''}>Peserta PKL</option>
                            </select>
                        </div>
                    </td>
                    <td class="py-3 px-4">
                        <div class="editable-field" data-field="status">
                            <span class="display-value px-2 py-1 text-xs font-medium rounded-full ${getStatusBadgeClass(user.Status)}">
                                ${user.Status || 'N/A'}
                            </span>
                            <select class="edit-input hidden w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                <option value="Aktif" ${user.Status === 'Aktif' ? 'selected' : ''}>Aktif</option>
                                <option value="Nonaktif" ${user.Status === 'Nonaktif' ? 'selected' : ''}>Nonaktif</option>
                                <option value="Pending" ${user.Status === 'Pending' ? 'selected' : ''}>Pending</option>
                            </select>
                        </div>
                    </td>
                    <td class="py-3 px-4 text-gray-600 text-sm">
                        ${user['Tanggal Daftar'] || user.tanggalDaftar || 'N/A'}
                    </td>
                    <td class="py-3 px-4">
                        <div class="flex space-x-2">
                            <button onclick="viewUser('${userId}')" 
                                    class="text-green-600 hover:text-green-800 text-sm" title="Lihat Detail">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${isPending ? `
                                <button onclick="approveUser('${userId}')" 
                                        class="text-green-600 hover:text-green-800 text-sm" title="Setujui">
                                    <i class="fas fa-check-circle"></i>
                                </button>
                                <button onclick="rejectUser('${userId}')" 
                                        class="text-red-600 hover:text-red-800 text-sm" title="Tolak">
                                    <i class="fas fa-times-circle"></i>
                                </button>
                            ` : `
                                <button onclick="toggleEditMode('${userId}')" 
                                        class="edit-toggle-btn text-blue-600 hover:text-blue-800 text-sm" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="submitUserChanges('${userId}')" 
                                        class="submit-btn hidden text-green-600 hover:text-green-800 text-sm" title="Submit">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button onclick="cancelEdit('${userId}')" 
                                        class="cancel-btn hidden text-gray-600 hover:text-gray-800 text-sm" title="Cancel">
                                    <i class="fas fa-times"></i>
                                </button>
                                <button onclick="toggleUserStatus('${userId}')" 
                                        class="text-yellow-600 hover:text-yellow-800 text-sm" title="${user.Status === 'Aktif' ? 'Nonaktifkan' : 'Aktifkan'}">
                                    <i class="fas fa-${user.Status === 'Aktif' ? 'user-slash' : 'user-check'}"></i>
                                </button>
                            `}
                            <button onclick="deleteUser('${userId}')" 
                                    class="delete-btn text-red-600 hover:text-red-800 text-sm" title="Hapus">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
        }

        function displayPeserta(peserta) {
            const tbody = document.getElementById('pesertaTableBody');
            
            if (!peserta || peserta.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="13" class="text-center py-8 text-gray-500">
                            <i class="fas fa-user-graduate text-4xl mb-2 opacity-50"></i>
                            <p>Belum ada data peserta</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = peserta.map(p => {
                const pesertaId = p.ID || p._rowIndex;
                const isPending = p.Status === 'Pending';
                
                return `
                <tr id="pesertaRow_${pesertaId}" class="border-b border-gray-100 hover:bg-gray-50 ${isPending ? 'bg-yellow-50' : ''}" data-peserta-id="${pesertaId}">
                    <td class="py-3 px-4 text-gray-600 text-sm">${pesertaId}</td>
                    <td class="py-3 px-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 ${isPending ? 'bg-yellow-100' : 'bg-green-100'} rounded-full flex items-center justify-center">
                                <i class="fas fa-user-graduate ${isPending ? 'text-yellow-600' : 'text-green-600'} text-sm"></i>
                            </div>
                            <div class="editable-field" data-field="namaLengkap">
                                <span class="display-value font-medium text-gray-800">${p['Nama Lengkap'] || 'N/A'}</span>
                                <input type="text" class="edit-input hidden w-full px-2 py-1 border border-gray-300 rounded text-sm font-medium" 
                                       value="${p['Nama Lengkap'] || ''}">
                            </div>
                        </div>
                    </td>
                    <td class="py-3 px-4">
                        <div class="editable-field" data-field="nimNisn">
                            <span class="display-value text-gray-600">${p['NIM/NISN'] || 'N/A'}</span>
                            <input type="text" class="edit-input hidden w-full px-2 py-1 border border-gray-300 rounded text-sm" 
                                   value="${p['NIM/NISN'] || ''}">
                        </div>
                    </td>
                    <td class="py-3 px-4">
                        <div class="editable-field" data-field="asalSekolahPT">
                            <span class="display-value text-gray-600">${p['Asal Sekolah/PT'] || 'N/A'}</span>
                            <input type="text" class="edit-input hidden w-full px-2 py-1 border border-gray-300 rounded text-sm" 
                                   value="${p['Asal Sekolah/PT'] || ''}">
                        </div>
                    </td>
                    <td class="py-3 px-4">
                        <div class="editable-field" data-field="jurusan">
                            <span class="display-value text-gray-600">${p.Jurusan || 'N/A'}</span>
                            <input type="text" class="edit-input hidden w-full px-2 py-1 border border-gray-300 rounded text-sm" 
                                   value="${p.Jurusan || ''}">
                        </div>
                    </td>
                    <td class="py-3 px-4">
                        <div class="editable-field" data-field="kategori">
                            <span class="display-value px-2 py-1 text-xs font-medium rounded-full ${getKategoriBadgeClass(p.Kategori)}">
                                ${p.Kategori || 'N/A'}
                            </span>
                            <select class="edit-input hidden w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                <option value="Magang" ${p.Kategori === 'Magang' ? 'selected' : ''}>Magang</option>
                                <option value="PKL" ${p.Kategori === 'PKL' ? 'selected' : ''}>PKL</option>
                            </select>
                        </div>
                    </td>
                    <td class="py-3 px-4">
                        <div class="editable-field" data-field="pembimbingBPS">
                            <span class="display-value text-gray-600">${p['Pembimbing BPS'] || 'N/A'}</span>
                            <select class="edit-input hidden w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                <option value="">Pilih Pembimbing BPS</option>
                            </select>
                        </div>
                    </td>
                    <td class="py-3 px-4">
                        <div class="editable-field" data-field="guruDosenAsal">
                            <span class="display-value text-gray-600">${p['Guru/Dosen Asal'] || 'N/A'}</span>
                            <input type="text" class="edit-input hidden w-full px-2 py-1 border border-gray-300 rounded text-sm" 
                                   value="${p['Guru/Dosen Asal'] || ''}">
                        </div>
                    </td>
                    <td class="py-3 px-4">
                        <div class="editable-field" data-field="email">
                            <span class="display-value text-gray-600">${p.Email || 'N/A'}</span>
                            <input type="email" class="edit-input hidden w-full px-2 py-1 border border-gray-300 rounded text-sm" 
                                   value="${p.Email || ''}">
                        </div>
                    </td>
                    <td class="py-3 px-4">
                        <div class="editable-field" data-field="noTelepon">
                            <span class="display-value text-gray-600">${p['No. Telepon'] || 'N/A'}</span>
                            <input type="tel" class="edit-input hidden w-full px-2 py-1 border border-gray-300 rounded text-sm" 
                                   value="${p['No. Telepon'] || ''}">
                        </div>
                    </td>
                    <td class="py-3 px-4">
                        <div class="editable-field" data-field="tanggalMulai">
                            <span class="display-value text-gray-600 text-sm">${p['Tanggal Mulai'] || 'N/A'}</span>
                            <input type="date" class="edit-input hidden w-full px-2 py-1 border border-gray-300 rounded text-sm" 
                                   value="${p['Tanggal Mulai'] || ''}">
                        </div>
                    </td>
                    <td class="py-3 px-4">
                        <div class="editable-field" data-field="tanggalSelesai">
                            <span class="display-value text-gray-600 text-sm">${p['Tanggal Selesai'] || 'N/A'}</span>
                            <input type="date" class="edit-input hidden w-full px-2 py-1 border border-gray-300 rounded text-sm" 
                                   value="${p['Tanggal Selesai'] || ''}">
                        </div>
                    </td>
                    <td class="py-3 px-4">
                        <div class="editable-field" data-field="status">
                            <span class="display-value px-2 py-1 text-xs font-medium rounded-full ${getStatusBadgeClass(p.Status)}">
                                ${p.Status || 'N/A'}
                            </span>
                            <select class="edit-input hidden w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                <option value="Aktif" ${p.Status === 'Aktif' ? 'selected' : ''}>Aktif</option>
                                <option value="Nonaktif" ${p.Status === 'Nonaktif' ? 'selected' : ''}>Nonaktif</option>
                                <option value="Pending" ${p.Status === 'Pending' ? 'selected' : ''}>Pending</option>
                                <option value="Selesai" ${p.Status === 'Selesai' ? 'selected' : ''}>Selesai</option>
                            </select>
                        </div>
                    </td>
                    <td class="py-3 px-4">
                        <div class="flex space-x-2">
                            <button onclick="viewPeserta('${pesertaId}')" 
                                    class="text-green-600 hover:text-green-800 text-sm" title="Lihat Detail">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${isPending ? `
                                <button onclick="approvePeserta('${pesertaId}')" 
                                        class="text-green-600 hover:text-green-800 text-sm" title="Setujui">
                                    <i class="fas fa-check-circle"></i>
                                </button>
                                <button onclick="rejectPeserta('${pesertaId}')" 
                                        class="text-red-600 hover:text-red-800 text-sm" title="Tolak">
                                    <i class="fas fa-times-circle"></i>
                                </button>
                            ` : `
                                <button onclick="togglePesertaEditMode('${pesertaId}')" 
                                        class="edit-toggle-btn text-blue-600 hover:text-blue-800 text-sm" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="submitPesertaChanges('${pesertaId}')" 
                                        class="submit-btn hidden text-green-600 hover:text-green-800 text-sm" title="Submit">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button onclick="cancelPesertaEdit('${pesertaId}')" 
                                        class="cancel-btn hidden text-gray-600 hover:text-gray-800 text-sm" title="Cancel">
                                    <i class="fas fa-times"></i>
                                </button>
                                <button onclick="togglePesertaStatus('${pesertaId}')" 
                                        class="text-yellow-600 hover:text-yellow-800 text-sm" title="${p.Status === 'Aktif' ? 'Nonaktifkan' : 'Aktifkan'}">
                                    <i class="fas fa-${p.Status === 'Aktif' ? 'user-slash' : 'user-check'}"></i>
                                </button>
                            `}
                            <button onclick="deletePesertaConfirm('${pesertaId}')" 
                                    class="delete-btn text-red-600 hover:text-red-800 text-sm" title="Hapus">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
        }

        // Utility Functions
        function getRoleBadgeClass(role) {
            switch(role) {
                case 'Admin': return 'bg-red-100 text-red-800';
                case 'Pembimbing BPS': return 'bg-blue-100 text-blue-800';
                case 'Peserta Magang': return 'bg-green-100 text-green-800';
                case 'Peserta PKL': return 'bg-yellow-100 text-yellow-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getStatusBadgeClass(status) {
            switch(status) {
                case 'Aktif': return 'bg-green-100 text-green-800';
                case 'Pending': return 'bg-yellow-100 text-yellow-800';
                case 'Nonaktif': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getKategoriBadgeClass(kategori) {
            switch(kategori) {
                case 'Magang': return 'bg-blue-100 text-blue-800';
                case 'PKL': return 'bg-green-100 text-green-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getAbsensiBadgeClass(status) {
            switch(status) {
                case 'Hadir': return 'bg-green-100 text-green-800';
                case 'Izin': return 'bg-yellow-100 text-yellow-800';
                case 'Sakit': return 'bg-blue-100 text-blue-800';
                case 'Alpha': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getPriorityBadgeClass(priority) {
            switch(priority) {
                case 'High': return 'bg-red-100 text-red-800';
                case 'Medium': return 'bg-yellow-100 text-yellow-800';
                case 'Low': return 'bg-green-100 text-green-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getTugasStatusBadgeClass(status) {
            switch(status) {
                case 'Pending': return 'bg-yellow-100 text-yellow-800';
                case 'In Progress': return 'bg-blue-100 text-blue-800';
                case 'Completed': return 'bg-green-100 text-green-800';
                case 'Overdue': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getLaporanStatusBadgeClass(status) {
            switch(status) {
                case 'Draft': return 'bg-gray-100 text-gray-800';
                case 'Submitted': return 'bg-blue-100 text-blue-800';
                case 'Reviewed': return 'bg-yellow-100 text-yellow-800';
                case 'Approved': return 'bg-green-100 text-green-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getJenisSuratBadgeClass(jenis) {
            switch(jenis) {
                case 'Surat Masuk': return 'bg-blue-100 text-blue-800';
                case 'Surat Keluar': return 'bg-green-100 text-green-800';
                case 'Surat Tugas': return 'bg-purple-100 text-purple-800';
                case 'Surat Keterangan': return 'bg-yellow-100 text-yellow-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getSuratStatusBadgeClass(status) {
            switch(status) {
                case 'Draft': return 'bg-gray-100 text-gray-800';
                case 'Issued': return 'bg-green-100 text-green-800';
                case 'Sent': return 'bg-blue-100 text-blue-800';
                case 'Received': return 'bg-purple-100 text-purple-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getSertifikatStatusBadgeClass(status) {
            switch(status) {
                case 'Draft': return 'bg-gray-100 text-gray-800';
                case 'Generated': return 'bg-blue-100 text-blue-800';
                case 'Issued': return 'bg-green-100 text-green-800';
                case 'Delivered': return 'bg-purple-100 text-purple-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // UI Functions
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };

            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };

            const notification = document.createElement('div');
            notification.className = `notification ${colors[type]} text-white p-4 rounded-lg shadow-lg mb-4`;
            notification.innerHTML = `
                <div class="flex items-center space-x-3">
                    <i class="${icons[type]}"></i>
                    <span class="flex-1">${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;

            container.appendChild(notification);

            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        function updateUserInfo(user) {
            document.getElementById('sidebarUserName').textContent = user.namaLengkap || user.username;
            document.getElementById('sidebarUserRole').textContent = user.role;
            document.getElementById('headerUserName').textContent = user.namaLengkap || user.username;
            document.getElementById('headerUserRole').textContent = user.role;
        }

        function showDashboard() {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
        }

        function hideLoginModal() {
            document.getElementById('loginModal').classList.add('hidden');
        }

        function showRegisterModal() {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('registerModal').classList.remove('hidden');
        }

        function hideRegisterModal() {
            document.getElementById('registerModal').classList.add('hidden');
            document.getElementById('loginModal').classList.remove('hidden');
        }

        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });

            // Show selected section
            document.getElementById(sectionId).classList.remove('hidden');

            // Update page title
            const titles = {
                'dashboard-overview': 'Dashboard',
                'users-management': 'Manajemen User',
                'peserta-management': 'Data Peserta',
                'absensi-management': 'Absensi',
                'tugas-management': 'Tugas',
                'laporan-management': 'Laporan',
                'surat-management': 'Surat',
                'sertifikat-management': 'Sertifikat',
                'dokumentasi-management': 'Dokumentasi',
                'admin-management': 'Manajemen Admin'
            };

            document.getElementById('pageTitle').textContent = titles[sectionId] || 'Dashboard';

            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('bg-blue-50', 'text-blue-600');
            });

            // Load section data
            if (sectionId === 'users-management') {
                loadUsers();
            } else if (sectionId === 'peserta-management') {
                loadPeserta();
            } else if (sectionId === 'absensi-management') {
                loadAbsensi();
            } else if (sectionId === 'tugas-management') {
                loadTugas();
            } else if (sectionId === 'laporan-management') {
                loadLaporan();
            } else if (sectionId === 'surat-management') {
                loadSurat();
            } else if (sectionId === 'sertifikat-management') {
                loadSertifikat();
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            
            sidebarCollapsed = !sidebarCollapsed;
            
            if (sidebarCollapsed) {
                sidebar.style.marginLeft = '-256px';
                mainContent.style.marginLeft = '0';
            } else {
                sidebar.style.marginLeft = '0';
                mainContent.style.marginLeft = '256px';
            }
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const icon = input.nextElementSibling.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('loginModal').classList.remove('hidden');
            showNotification('Anda telah logout', 'info');
        }

        // Event Listeners
        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const username = document.getElementById('loginUsername').value;
                const password = document.getElementById('loginPassword').value;
                
                const loginButton = document.getElementById('loginButtonText');
                const loginLoading = document.getElementById('loginButtonLoading');
                
                loginButton.classList.add('hidden');
                loginLoading.classList.remove('hidden');
                
                const success = await login(username, password);
                
                loginButton.classList.remove('hidden');
                loginLoading.classList.add('hidden');
                
                if (!success) {
                    document.getElementById('loginPassword').value = '';
                }
            });

            // Register form
            document.getElementById('registerForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const userData = {
                    namaLengkap: document.getElementById('regNamaLengkap').value,
                    username: document.getElementById('regUsername').value,
                    email: document.getElementById('regEmail').value,
                    password: document.getElementById('regPassword').value,
                    role: document.getElementById('regRole').value,
                    noTelepon: document.getElementById('regNoTelepon').value
                };
                
                const registerButton = document.getElementById('registerButtonText');
                const registerLoading = document.getElementById('registerButtonLoading');
                
                registerButton.classList.add('hidden');
                registerLoading.classList.remove('hidden');
                
                const success = await register(userData);
                
                registerButton.classList.remove('hidden');
                registerLoading.classList.add('hidden');
                
                if (success) {
                    document.getElementById('registerForm').reset();
                }
            });

            // Add User form
            document.getElementById('addUserForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const userData = {
                    namaLengkap: document.getElementById('addUserNamaLengkap').value,
                    username: document.getElementById('addUserUsername').value,
                    email: document.getElementById('addUserEmail').value,
                    password: document.getElementById('addUserPassword').value,
                    role: document.getElementById('addUserRole').value,
                    noTelepon: document.getElementById('addUserNoTelepon').value,
                    status: document.getElementById('addUserStatus').value
                };
                
                const addButton = document.getElementById('addUserButtonText');
                const addLoading = document.getElementById('addUserButtonLoading');
                
                addButton.classList.add('hidden');
                addLoading.classList.remove('hidden');
                
                const success = await addUser(userData);
                
                addButton.classList.remove('hidden');
                addLoading.classList.add('hidden');
                
                if (success) {
                    document.getElementById('addUserForm').reset();
                }
            });

            // Edit User form
            document.getElementById('editUserForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const userId = document.getElementById('editUserId').value;
                const userData = {
                    namaLengkap: document.getElementById('editUserNamaLengkap').value,
                    username: document.getElementById('editUserUsername').value,
                    email: document.getElementById('editUserEmail').value,
                    role: document.getElementById('editUserRole').value,
                    noTelepon: document.getElementById('editUserNoTelepon').value,
                    status: document.getElementById('editUserStatus').value
                };
                
                const editButton = document.getElementById('editUserButtonText');
                const editLoading = document.getElementById('editUserButtonLoading');
                
                editButton.classList.add('hidden');
                editLoading.classList.remove('hidden');
                
                const success = await updateUser(userId, userData);
                
                editButton.classList.remove('hidden');
                editLoading.classList.add('hidden');
                
                if (success) {
                    document.getElementById('editUserForm').reset();
                }
            });

            // Add Peserta form
            document.getElementById('addPesertaForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const pesertaData = {
                    namaLengkap: document.getElementById('addPesertaNamaLengkap').value,
                    nimNisn: document.getElementById('addPesertaNimNisn').value,
                    asalSekolahPT: document.getElementById('addPesertaAsalSekolahPT').value,
                    jurusan: document.getElementById('addPesertaJurusan').value,
                    kategori: document.getElementById('addPesertaKategori').value,
                    pembimbingBPS: document.getElementById('addPesertaPembimbingBPS').value,
                    guruDosenAsal: document.getElementById('addPesertaGuruDosenAsal').value,
                    email: document.getElementById('addPesertaEmail').value,
                    noTelepon: document.getElementById('addPesertaNoTelepon').value,
                    tanggalMulai: document.getElementById('addPesertaTanggalMulai').value,
                    tanggalSelesai: document.getElementById('addPesertaTanggalSelesai').value,
                    status: document.getElementById('addPesertaStatus').value
                };
                
                const addButton = document.getElementById('addPesertaButtonText');
                const addLoading = document.getElementById('addPesertaButtonLoading');
                
                addButton.classList.add('hidden');
                addLoading.classList.remove('hidden');
                
                const success = await addPeserta(pesertaData);
                
                addButton.classList.remove('hidden');
                addLoading.classList.add('hidden');
                
                if (success) {
                    document.getElementById('addPesertaForm').reset();
                }
            });

            // Add Tugas form
            document.getElementById('addTugasForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const tugasData = {
                    judulTugas: document.getElementById('addTugasJudul').value,
                    deskripsi: document.getElementById('addTugasDeskripsi').value,
                    assignedTo: document.getElementById('addTugasAssignTo').value,
                    deadline: document.getElementById('addTugasDeadline').value,
                    priority: document.getElementById('addTugasPriority').value,
                    status: document.getElementById('addTugasStatus').value
                };
                
                const addButton = document.getElementById('addTugasButtonText');
                const addLoading = document.getElementById('addTugasButtonLoading');
                
                addButton.classList.add('hidden');
                addLoading.classList.remove('hidden');
                
                const success = await addTugas(tugasData);
                
                addButton.classList.remove('hidden');
                addLoading.classList.add('hidden');
                
                if (success) {
                    document.getElementById('addTugasForm').reset();
                }
            });
        }

        // Management Functions
        function showAddUserModal() {
            document.getElementById('addUserModal').classList.remove('hidden');
        }

        async function showAddPesertaModal() {
            // Load pembimbing dropdown
            await loadPembimbingDropdown('addPesertaPembimbingBPS');
            document.getElementById('addPesertaModal').classList.remove('hidden');
        }

        function hideAddPesertaModal() {
            document.getElementById('addPesertaModal').classList.add('hidden');
            document.getElementById('addPesertaForm').reset();
        }

        function hideViewPesertaModal() {
            document.getElementById('viewPesertaModal').classList.add('hidden');
        }

        // Load pembimbing dropdown
        async function loadPembimbingDropdown(selectId) {
            try {
                const pembimbingList = await getPembimbingList();
                const select = document.getElementById(selectId);
                
                if (!select) return;
                
                // Clear existing options except first one
                const firstOption = select.querySelector('option');
                select.innerHTML = '';
                if (firstOption) {
                    select.appendChild(firstOption);
                }
                
                // Add pembimbing options
                pembimbingList.forEach(pembimbing => {
                    const option = document.createElement('option');
                    option.value = pembimbing['Nama Lengkap'] || pembimbing.namaLengkap;
                    option.textContent = pembimbing['Nama Lengkap'] || pembimbing.namaLengkap;
                    select.appendChild(option);
                });
                
                console.log(`✅ Loaded ${pembimbingList.length} pembimbing to dropdown ${selectId}`);
                
            } catch (error) {
                console.error('❌ Error loading pembimbing dropdown:', error);
                showNotification('Error loading pembimbing list', 'error');
            }
        }

        // Load peserta dropdown for tugas assignment
        async function loadPesertaDropdown(selectId, pembimbingName = null) {
            try {
                let pesertaList = [];
                
                if (currentUser && currentUser.role === 'Pembimbing BPS') {
                    // Show only peserta under this pembimbing
                    pesertaList = getPesertaByPembimbing(currentUser.namaLengkap);
                } else if (pembimbingName) {
                    // Show peserta under specific pembimbing
                    pesertaList = getPesertaByPembimbing(pembimbingName);
                } else {
                    // Show all active peserta (for admin)
                    const allPeserta = dataCache.peserta || await loadPeserta();
                    pesertaList = allPeserta.filter(p => p.Status === 'Aktif');
                }
                
                const select = document.getElementById(selectId);
                if (!select) return;
                
                // Clear existing options except first one
                const firstOption = select.querySelector('option');
                select.innerHTML = '';
                if (firstOption) {
                    select.appendChild(firstOption);
                }
                
                // Add peserta options
                pesertaList.forEach(peserta => {
                    const option = document.createElement('option');
                    option.value = peserta['Nama Lengkap'];
                    option.textContent = `${peserta['Nama Lengkap']} (${peserta.Kategori})`;
                    select.appendChild(option);
                });
                
                console.log(`✅ Loaded ${pesertaList.length} peserta to dropdown ${selectId}`);
                
            } catch (error) {
                console.error('❌ Error loading peserta dropdown:', error);
                showNotification('Error loading peserta list', 'error');
            }
        }

        // Peserta Edit Functions
        function togglePesertaEditMode(pesertaId) {
            const row = document.getElementById(`pesertaRow_${pesertaId}`);
            if (!row) return;

            const isEditing = row.classList.contains('editing-mode');
            
            if (isEditing) {
                // Cancel edit mode
                cancelPesertaEdit(pesertaId);
            } else {
                // Enter edit mode
                row.classList.add('editing-mode');
                
                // Show edit inputs, hide display values
                const editableFields = row.querySelectorAll('.editable-field');
                editableFields.forEach(field => {
                    const displayValue = field.querySelector('.display-value');
                    const editInput = field.querySelector('.edit-input');
                    
                    if (displayValue && editInput) {
                        displayValue.classList.add('hidden');
                        editInput.classList.remove('hidden');
                        
                        // Focus on first input
                        if (field.dataset.field === 'namaLengkap') {
                            editInput.focus();
                        }
                    }
                });
                
                // Toggle buttons
                const editBtn = row.querySelector('.edit-toggle-btn');
                const submitBtn = row.querySelector('.submit-btn');
                const cancelBtn = row.querySelector('.cancel-btn');
                const deleteBtn = row.querySelector('.delete-btn');
                
                if (editBtn) editBtn.classList.add('hidden');
                if (submitBtn) submitBtn.classList.remove('hidden');
                if (cancelBtn) cancelBtn.classList.remove('hidden');
                if (deleteBtn) deleteBtn.classList.add('hidden');
                
                showNotification('Mode edit aktif. Ubah data lalu klik Submit untuk menyimpan.', 'info');
            }
        }

        function cancelPesertaEdit(pesertaId) {
            const row = document.getElementById(`pesertaRow_${pesertaId}`);
            if (!row) return;

            row.classList.remove('editing-mode');
            
            // Hide edit inputs, show display values
            const editableFields = row.querySelectorAll('.editable-field');
            editableFields.forEach(field => {
                const displayValue = field.querySelector('.display-value');
                const editInput = field.querySelector('.edit-input');
                
                if (displayValue && editInput) {
                    displayValue.classList.remove('hidden');
                    editInput.classList.add('hidden');
                    
                    // Reset input values to original
                    const originalData = getOriginalPesertaData(pesertaId);
                    if (originalData) {
                        const fieldName = field.dataset.field;
                        let originalValue = '';
                        
                        switch(fieldName) {
                            case 'namaLengkap':
                                originalValue = originalData['Nama Lengkap'] || '';
                                break;
                            case 'nimNisn':
                                originalValue = originalData['NIM/NISN'] || '';
                                break;
                            case 'asalSekolahPT':
                                originalValue = originalData['Asal Sekolah/PT'] || '';
                                break;
                            case 'jurusan':
                                originalValue = originalData.Jurusan || '';
                                break;
                            case 'kategori':
                                originalValue = originalData.Kategori || '';
                                break;
                            case 'pembimbingBPS':
                                originalValue = originalData['Pembimbing BPS'] || '';
                                break;
                            case 'guruDosenAsal':
                                originalValue = originalData['Guru/Dosen Asal'] || '';
                                break;
                            case 'email':
                                originalValue = originalData.Email || '';
                                break;
                            case 'noTelepon':
                                originalValue = originalData['No. Telepon'] || '';
                                break;
                            case 'tanggalMulai':
                                originalValue = originalData['Tanggal Mulai'] || '';
                                break;
                            case 'tanggalSelesai':
                                originalValue = originalData['Tanggal Selesai'] || '';
                                break;
                            case 'status':
                                originalValue = originalData.Status || '';
                                break;
                        }
                        
                        if (editInput.tagName === 'SELECT') {
                            editInput.value = originalValue;
                        } else {
                            editInput.value = originalValue;
                        }
                    }
                }
            });
            
            // Toggle buttons back
            const editBtn = row.querySelector('.edit-toggle-btn');
            const submitBtn = row.querySelector('.submit-btn');
            const cancelBtn = row.querySelector('.cancel-btn');
            const deleteBtn = row.querySelector('.delete-btn');
            
            if (editBtn) editBtn.classList.remove('hidden');
            if (submitBtn) submitBtn.classList.add('hidden');
            if (cancelBtn) cancelBtn.classList.add('hidden');
            if (deleteBtn) deleteBtn.classList.remove('hidden');
        }

        function getOriginalPesertaData(pesertaId) {
            const peserta = dataCache.peserta || [];
            return peserta.find(p => (p.ID || p._rowIndex) == pesertaId);
        }

        async function submitPesertaChanges(pesertaId) {
            const row = document.getElementById(`pesertaRow_${pesertaId}`);
            if (!row) return;

            try {
                // Collect data from edit inputs
                const pesertaData = {};
                const editableFields = row.querySelectorAll('.editable-field');
                
                editableFields.forEach(field => {
                    const editInput = field.querySelector('.edit-input');
                    const fieldName = field.dataset.field;
                    
                    if (editInput) {
                        switch(fieldName) {
                            case 'namaLengkap':
                                pesertaData.namaLengkap = editInput.value.trim();
                                break;
                            case 'nimNisn':
                                pesertaData.nimNisn = editInput.value.trim();
                                break;
                            case 'asalSekolahPT':
                                pesertaData.asalSekolahPT = editInput.value.trim();
                                break;
                            case 'jurusan':
                                pesertaData.jurusan = editInput.value.trim();
                                break;
                            case 'kategori':
                                pesertaData.kategori = editInput.value;
                                break;
                            case 'pembimbingBPS':
                                pesertaData.pembimbingBPS = editInput.value.trim();
                                break;
                            case 'guruDosenAsal':
                                pesertaData.guruDosenAsal = editInput.value.trim();
                                break;
                            case 'email':
                                pesertaData.email = editInput.value.trim();
                                break;
                            case 'noTelepon':
                                pesertaData.noTelepon = editInput.value.trim();
                                break;
                            case 'tanggalMulai':
                                pesertaData.tanggalMulai = editInput.value;
                                break;
                            case 'tanggalSelesai':
                                pesertaData.tanggalSelesai = editInput.value;
                                break;
                            case 'status':
                                pesertaData.status = editInput.value;
                                break;
                        }
                    }
                });

                // Validate required fields
                if (!pesertaData.namaLengkap || !pesertaData.email) {
                    showNotification('Nama lengkap dan email harus diisi!', 'error');
                    return;
                }

                // Validate email format
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(pesertaData.email)) {
                    showNotification('Format email tidak valid!', 'error');
                    return;
                }

                // Show loading state
                const submitBtn = row.querySelector('.submit-btn');
                const originalSubmitHTML = submitBtn.innerHTML;
                submitBtn.innerHTML = '<div class="loading"></div>';
                submitBtn.disabled = true;

                console.log('💾 Submitting peserta changes:', pesertaId, pesertaData);

                // Call API to update peserta
                const result = await updatePeserta(pesertaId, pesertaData);

                // Restore button
                submitBtn.innerHTML = originalSubmitHTML;
                submitBtn.disabled = false;

                if (result) {
                    // Exit edit mode
                    cancelPesertaEdit(pesertaId);
                    
                    // Refresh data from server
                    await loadPeserta(true);
                }

            } catch (error) {
                console.error('❌ Error submitting peserta changes:', error);
                showNotification('Error update peserta: ' + error.message, 'error');
                
                // Restore button
                const submitBtn = row.querySelector('.submit-btn');
                if (submitBtn) {
                    submitBtn.innerHTML = '<i class="fas fa-check"></i>';
                    submitBtn.disabled = false;
                }
            }
        }

        function viewPeserta(pesertaId) {
            // Find peserta data
            const peserta = dataCache.peserta || [];
            const pesertaData = peserta.find(p => (p.ID || p._rowIndex) == pesertaId);
            
            if (!pesertaData) {
                showNotification('Data peserta tidak ditemukan', 'error');
                return;
            }

            // Populate view modal
            document.getElementById('viewPesertaNamaLengkap').textContent = pesertaData['Nama Lengkap'] || '-';
            document.getElementById('viewPesertaNimNisn').textContent = pesertaData['NIM/NISN'] || '-';
            document.getElementById('viewPesertaAsalSekolahPT').textContent = pesertaData['Asal Sekolah/PT'] || '-';
            document.getElementById('viewPesertaJurusan').textContent = pesertaData.Jurusan || '-';
            document.getElementById('viewPesertaKategori').textContent = pesertaData.Kategori || '-';
            document.getElementById('viewPesertaPembimbingBPS').textContent = pesertaData['Pembimbing BPS'] || '-';
            document.getElementById('viewPesertaGuruDosenAsal').textContent = pesertaData['Guru/Dosen Asal'] || '-';
            document.getElementById('viewPesertaEmail').textContent = pesertaData.Email || '-';
            document.getElementById('viewPesertaNoTelepon').textContent = pesertaData['No. Telepon'] || '-';
            document.getElementById('viewPesertaTanggalMulai').textContent = pesertaData['Tanggal Mulai'] || '-';
            document.getElementById('viewPesertaTanggalSelesai').textContent = pesertaData['Tanggal Selesai'] || '-';
            document.getElementById('viewPesertaStatus').textContent = pesertaData.Status || '-';

            // Show modal
            document.getElementById('viewPesertaModal').classList.remove('hidden');
        }

        async function approvePeserta(pesertaId) {
            try {
                if (!confirm('Apakah Anda yakin ingin menyetujui peserta ini?')) {
                    return;
                }

                console.log('✅ Approving peserta:', pesertaId);
                
                const result = await apiCall('', 'POST', {
                    action: 'updatePesertaStatus',
                    sheetId: SHEET_ID,
                    sheetName: 'PESERTA',
                    pesertaId: pesertaId,
                    status: 'Aktif'
                });

                if (result.success) {
                    showNotification('Peserta berhasil disetujui dan diaktifkan!', 'success');
                    loadPeserta(true); // Force refresh
                } else {
                    showNotification(result.message || 'Gagal menyetujui peserta', 'error');
                }
            } catch (error) {
                console.error('❌ Error approving peserta:', error);
                showNotification('Error menyetujui peserta: ' + error.message, 'error');
            }
        }

        async function rejectPeserta(pesertaId) {
            try {
                if (!confirm('Apakah Anda yakin ingin menolak peserta ini? Data akan dihapus dari sistem.')) {
                    return;
                }

                console.log('❌ Rejecting peserta:', pesertaId);
                
                const result = await deletePeserta(pesertaId);

                if (result) {
                    showNotification('Peserta berhasil ditolak dan dihapus!', 'success');
                }
            } catch (error) {
                console.error('❌ Error rejecting peserta:', error);
                showNotification('Error menolak peserta: ' + error.message, 'error');
            }
        }

        function deletePesertaConfirm(pesertaId) {
            if (confirm('Apakah Anda yakin ingin menghapus peserta ini?')) {
                deletePeserta(pesertaId);
            }
        }

        function showAddAbsensiModal() {
            showNotification('Fitur input absensi akan segera tersedia', 'info');
        }

        async function showAddTugasModal() {
            // Load peserta data for assignment dropdown
            await loadPesertaDropdown('addTugasAssignTo');
            
            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('addTugasDeadline').min = today;
            
            document.getElementById('addTugasModal').classList.remove('hidden');
        }

        function hideAddTugasModal() {
            document.getElementById('addTugasModal').classList.add('hidden');
            document.getElementById('addTugasForm').reset();
        }

        function showAddLaporanModal() {
            showNotification('Fitur tambah laporan akan segera tersedia', 'info');
        }

        function showAddSuratModal() {
            showNotification('Fitur buat surat akan segera tersedia', 'info');
        }

        function showAddSertifikatModal() {
            showNotification('Fitur generate sertifikat akan segera tersedia', 'info');
        }

        // User Management Functions
        async function addUser(userData) {
            try {
                console.log('➕ Adding new user to ADMIN sheet:', userData);
                
                const result = await apiCall('', 'POST', {
                    action: 'addUser',
                    sheetId: SHEET_ID,
                    sheetName: 'ADMIN',
                    namaLengkap: userData.namaLengkap,
                    username: userData.username,
                    email: userData.email,
                    password: userData.password,
                    role: userData.role,
                    noTelepon: userData.noTelepon || '',
                    status: userData.status,
                    tanggalDaftar: new Date().toISOString().split('T')[0]
                });

                if (result.success) {
                    showNotification('User berhasil ditambahkan!', 'success');
                    hideAddUserModal();
                    loadUsers(true); // Force refresh
                    return true;
                } else {
                    showNotification(result.message || 'Gagal menambah user', 'error');
                    return false;
                }
            } catch (error) {
                console.error('❌ Error adding user:', error);
                showNotification('Error menambah user: ' + error.message, 'error');
                return false;
            }
        }

        async function updateUser(userId, userData) {
            try {
                console.log('✏️ Updating user in ADMIN sheet:', userId, userData);
                
                const result = await apiCall('', 'POST', {
                    action: 'updateUser',
                    sheetId: SHEET_ID,
                    sheetName: 'ADMIN',
                    userId: userId,
                    namaLengkap: userData.namaLengkap,
                    username: userData.username,
                    email: userData.email,
                    role: userData.role,
                    noTelepon: userData.noTelepon || '',
                    status: userData.status
                });

                if (result.success) {
                    showNotification('User berhasil diupdate!', 'success');
                    hideEditUserModal();
                    loadUsers(true); // Force refresh
                    return true;
                } else {
                    showNotification(result.message || 'Gagal update user', 'error');
                    return false;
                }
            } catch (error) {
                console.error('❌ Error updating user:', error);
                showNotification('Error update user: ' + error.message, 'error');
                return false;
            }
        }

        async function removeUser(userId) {
            try {
                console.log('🗑️ Deleting user from ADMIN sheet:', userId);
                
                const result = await apiCall('', 'POST', {
                    action: 'deleteUser',
                    sheetId: SHEET_ID,
                    sheetName: 'ADMIN',
                    userId: userId
                });

                if (result.success) {
                    showNotification('User berhasil dihapus!', 'success');
                    loadUsers(true); // Force refresh
                    return true;
                } else {
                    showNotification(result.message || 'Gagal hapus user', 'error');
                    return false;
                }
            } catch (error) {
                console.error('❌ Error deleting user:', error);
                showNotification('Error hapus user: ' + error.message, 'error');
                return false;
            }
        }

        function viewUser(userId) {
            // Find user data
            const users = dataCache.users || [];
            const user = users.find(u => (u.ID || u._rowIndex) == userId);
            
            if (!user) {
                showNotification('Data user tidak ditemukan', 'error');
                return;
            }

            // Populate view modal
            document.getElementById('viewUserNamaLengkap').textContent = user['Nama Lengkap'] || user.namaLengkap || '-';
            document.getElementById('viewUserUsername').textContent = user.Username || user.username || '-';
            document.getElementById('viewUserEmail').textContent = user.Email || user.email || '-';
            document.getElementById('viewUserRole').textContent = user.Role || user.role || '-';
            document.getElementById('viewUserNoTelepon').textContent = user['No. Telepon'] || user.noTelepon || '-';
            document.getElementById('viewUserStatus').textContent = user.Status || user.status || '-';
            document.getElementById('viewUserTanggalDibuat').textContent = user['Tanggal Dibuat'] || user.tanggalDibuat || '-';

            // Show modal
            document.getElementById('viewUserModal').classList.remove('hidden');
        }

        // Inline Edit Functions
        function toggleEditMode(userId) {
            const row = document.getElementById(`userRow_${userId}`);
            if (!row) return;

            const isEditing = row.classList.contains('editing-mode');
            
            if (isEditing) {
                // Cancel edit mode
                cancelEdit(userId);
            } else {
                // Enter edit mode
                row.classList.add('editing-mode');
                
                // Show edit inputs, hide display values
                const editableFields = row.querySelectorAll('.editable-field');
                editableFields.forEach(field => {
                    const displayValue = field.querySelector('.display-value');
                    const editInput = field.querySelector('.edit-input');
                    
                    if (displayValue && editInput) {
                        displayValue.classList.add('hidden');
                        editInput.classList.remove('hidden');
                        
                        // Focus on first input
                        if (field.dataset.field === 'namaLengkap') {
                            editInput.focus();
                        }
                    }
                });
                
                // Toggle buttons
                const editBtn = row.querySelector('.edit-toggle-btn');
                const submitBtn = row.querySelector('.submit-btn');
                const cancelBtn = row.querySelector('.cancel-btn');
                const deleteBtn = row.querySelector('.delete-btn');
                
                if (editBtn) editBtn.classList.add('hidden');
                if (submitBtn) submitBtn.classList.remove('hidden');
                if (cancelBtn) cancelBtn.classList.remove('hidden');
                if (deleteBtn) deleteBtn.classList.add('hidden');
                
                showNotification('Mode edit aktif. Ubah data lalu klik Submit untuk menyimpan.', 'info');
            }
        }

        function cancelEdit(userId) {
            const row = document.getElementById(`userRow_${userId}`);
            if (!row) return;

            row.classList.remove('editing-mode');
            
            // Hide edit inputs, show display values
            const editableFields = row.querySelectorAll('.editable-field');
            editableFields.forEach(field => {
                const displayValue = field.querySelector('.display-value');
                const editInput = field.querySelector('.edit-input');
                
                if (displayValue && editInput) {
                    displayValue.classList.remove('hidden');
                    editInput.classList.add('hidden');
                    
                    // Reset input values to original
                    const originalData = getOriginalUserData(userId);
                    if (originalData) {
                        const fieldName = field.dataset.field;
                        let originalValue = '';
                        
                        switch(fieldName) {
                            case 'namaLengkap':
                                originalValue = originalData['Nama Lengkap'] || originalData.namaLengkap || '';
                                break;
                            case 'username':
                                originalValue = originalData.Username || originalData.username || '';
                                break;
                            case 'email':
                                originalValue = originalData.Email || originalData.email || '';
                                break;
                            case 'role':
                                originalValue = originalData.Role || originalData.role || '';
                                break;
                            case 'status':
                                originalValue = originalData.Status || originalData.status || '';
                                break;
                        }
                        
                        if (editInput.tagName === 'SELECT') {
                            editInput.value = originalValue;
                        } else {
                            editInput.value = originalValue;
                        }
                    }
                }
            });
            
            // Toggle buttons back
            const editBtn = row.querySelector('.edit-toggle-btn');
            const submitBtn = row.querySelector('.submit-btn');
            const cancelBtn = row.querySelector('.cancel-btn');
            const deleteBtn = row.querySelector('.delete-btn');
            
            if (editBtn) editBtn.classList.remove('hidden');
            if (submitBtn) submitBtn.classList.add('hidden');
            if (cancelBtn) cancelBtn.classList.add('hidden');
            if (deleteBtn) deleteBtn.classList.remove('hidden');
        }

        function getOriginalUserData(userId) {
            const users = dataCache.users || [];
            return users.find(u => (u.ID || u._rowIndex) == userId);
        }

        async function submitUserChanges(userId) {
            const row = document.getElementById(`userRow_${userId}`);
            if (!row) return;

            try {
                // Collect data from edit inputs
                const userData = {};
                const editableFields = row.querySelectorAll('.editable-field');
                
                editableFields.forEach(field => {
                    const editInput = field.querySelector('.edit-input');
                    const fieldName = field.dataset.field;
                    
                    if (editInput) {
                        switch(fieldName) {
                            case 'namaLengkap':
                                userData.namaLengkap = editInput.value.trim();
                                break;
                            case 'username':
                                userData.username = editInput.value.trim();
                                break;
                            case 'email':
                                userData.email = editInput.value.trim();
                                break;
                            case 'role':
                                userData.role = editInput.value;
                                break;
                            case 'status':
                                userData.status = editInput.value;
                                break;
                        }
                    }
                });

                // Validate required fields
                if (!userData.namaLengkap || !userData.username || !userData.email || !userData.role || !userData.status) {
                    showNotification('Semua field harus diisi!', 'error');
                    return;
                }

                // Validate email format
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(userData.email)) {
                    showNotification('Format email tidak valid!', 'error');
                    return;
                }

                // Show loading state
                const submitBtn = row.querySelector('.submit-btn');
                const originalSubmitHTML = submitBtn.innerHTML;
                submitBtn.innerHTML = '<div class="loading"></div>';
                submitBtn.disabled = true;

                console.log('💾 Submitting user changes:', userId, userData);

                // Call API to update user
                const result = await apiCall('', 'POST', {
                    action: 'updateUser',
                    sheetId: SHEET_ID,
                    sheetName: 'ADMIN',
                    userId: userId,
                    namaLengkap: userData.namaLengkap,
                    username: userData.username,
                    email: userData.email,
                    role: userData.role,
                    status: userData.status
                });

                // Restore button
                submitBtn.innerHTML = originalSubmitHTML;
                submitBtn.disabled = false;

                if (result.success) {
                    showNotification('Data user berhasil diupdate!', 'success');
                    
                    // Exit edit mode
                    cancelEdit(userId);
                    
                    // Refresh data from server
                    await loadUsers(true);
                    
                } else {
                    showNotification(result.message || 'Gagal update user', 'error');
                }

            } catch (error) {
                console.error('❌ Error submitting user changes:', error);
                showNotification('Error update user: ' + error.message, 'error');
                
                // Restore button
                const submitBtn = row.querySelector('.submit-btn');
                if (submitBtn) {
                    submitBtn.innerHTML = '<i class="fas fa-check"></i>';
                    submitBtn.disabled = false;
                }
            }
        }

        // Legacy edit function (for modal - keeping for compatibility)
        function editUser(userId) {
            // Find user data
            const users = dataCache.users || [];
            const user = users.find(u => (u.ID || u._rowIndex) == userId);
            
            if (!user) {
                showNotification('Data user tidak ditemukan', 'error');
                return;
            }

            // Populate edit form
            document.getElementById('editUserId').value = userId;
            document.getElementById('editUserNamaLengkap').value = user['Nama Lengkap'] || user.namaLengkap || '';
            document.getElementById('editUserUsername').value = user.Username || user.username || '';
            document.getElementById('editUserEmail').value = user.Email || user.email || '';
            document.getElementById('editUserRole').value = user.Role || user.role || '';
            document.getElementById('editUserNoTelepon').value = user['No. Telepon'] || user.noTelepon || '';
            document.getElementById('editUserStatus').value = user.Status || user.status || '';

            // Show modal
            document.getElementById('editUserModal').classList.remove('hidden');
        }

        function editPeserta(rowIndex) {
            showNotification('Fitur edit peserta akan segera tersedia', 'info');
        }

        function editAbsensi(rowIndex) {
            showNotification('Fitur edit absensi akan segera tersedia', 'info');
        }

        // Tugas Edit Functions
        function toggleTugasEditMode(tugasId) {
            const row = document.getElementById(`tugasRow_${tugasId}`);
            if (!row) return;

            const isEditing = row.classList.contains('editing-mode');
            
            if (isEditing) {
                // Cancel edit mode
                cancelTugasEdit(tugasId);
            } else {
                // Enter edit mode
                row.classList.add('editing-mode');
                
                // Load peserta dropdown for assignment
                loadPesertaDropdownForEdit(tugasId);
                
                // Show edit inputs, hide display values
                const editableFields = row.querySelectorAll('.editable-field');
                editableFields.forEach(field => {
                    const displayValue = field.querySelector('.display-value');
                    const editInput = field.querySelector('.edit-input');
                    
                    if (displayValue && editInput) {
                        displayValue.classList.add('hidden');
                        editInput.classList.remove('hidden');
                        
                        // Focus on first input
                        if (field.dataset.field === 'judulTugas') {
                            editInput.focus();
                        }
                    }
                });
                
                // Toggle buttons
                const editBtn = row.querySelector('.edit-toggle-btn');
                const submitBtn = row.querySelector('.submit-btn');
                const cancelBtn = row.querySelector('.cancel-btn');
                const deleteBtn = row.querySelector('.delete-btn');
                
                if (editBtn) editBtn.classList.add('hidden');
                if (submitBtn) submitBtn.classList.remove('hidden');
                if (cancelBtn) cancelBtn.classList.remove('hidden');
                if (deleteBtn) deleteBtn.classList.add('hidden');
                
                showNotification('Mode edit aktif. Ubah data lalu klik Submit untuk menyimpan.', 'info');
            }
        }

        function cancelTugasEdit(tugasId) {
            const row = document.getElementById(`tugasRow_${tugasId}`);
            if (!row) return;

            row.classList.remove('editing-mode');
            
            // Hide edit inputs, show display values
            const editableFields = row.querySelectorAll('.editable-field');
            editableFields.forEach(field => {
                const displayValue = field.querySelector('.display-value');
                const editInput = field.querySelector('.edit-input');
                
                if (displayValue && editInput) {
                    displayValue.classList.remove('hidden');
                    editInput.classList.add('hidden');
                    
                    // Reset input values to original
                    const originalData = getOriginalTugasData(tugasId);
                    if (originalData) {
                        const fieldName = field.dataset.field;
                        let originalValue = '';
                        
                        switch(fieldName) {
                            case 'judulTugas':
                                originalValue = originalData['Judul Tugas'] || '';
                                break;
                            case 'assignedTo':
                                originalValue = originalData['Assigned To'] || '';
                                break;
                            case 'deadline':
                                originalValue = originalData.Deadline || '';
                                break;
                            case 'priority':
                                originalValue = originalData.Priority || '';
                                break;
                            case 'status':
                                originalValue = originalData.Status || '';
                                break;
                        }
                        
                        if (editInput.tagName === 'SELECT') {
                            editInput.value = originalValue;
                        } else {
                            editInput.value = originalValue;
                        }
                    }
                }
            });
            
            // Toggle buttons back
            const editBtn = row.querySelector('.edit-toggle-btn');
            const submitBtn = row.querySelector('.submit-btn');
            const cancelBtn = row.querySelector('.cancel-btn');
            const deleteBtn = row.querySelector('.delete-btn');
            
            if (editBtn) editBtn.classList.remove('hidden');
            if (submitBtn) submitBtn.classList.add('hidden');
            if (cancelBtn) cancelBtn.classList.add('hidden');
            if (deleteBtn) deleteBtn.classList.remove('hidden');
        }

        function getOriginalTugasData(tugasId) {
            const tugas = dataCache.tugas || [];
            return tugas.find(t => (t.ID || t._rowIndex) == tugasId);
        }

        async function submitTugasChanges(tugasId) {
            const row = document.getElementById(`tugasRow_${tugasId}`);
            if (!row) return;

            try {
                // Collect data from edit inputs
                const tugasData = {};
                const editableFields = row.querySelectorAll('.editable-field');
                
                editableFields.forEach(field => {
                    const editInput = field.querySelector('.edit-input');
                    const fieldName = field.dataset.field;
                    
                    if (editInput) {
                        switch(fieldName) {
                            case 'judulTugas':
                                tugasData.judulTugas = editInput.value.trim();
                                break;
                            case 'assignedTo':
                                tugasData.assignedTo = editInput.value;
                                break;
                            case 'deadline':
                                tugasData.deadline = editInput.value;
                                break;
                            case 'priority':
                                tugasData.priority = editInput.value;
                                break;
                            case 'status':
                                tugasData.status = editInput.value;
                                break;
                        }
                    }
                });

                // Validate required fields
                if (!tugasData.judulTugas || !tugasData.assignedTo || !tugasData.deadline || !tugasData.priority || !tugasData.status) {
                    showNotification('Semua field harus diisi!', 'error');
                    return;
                }

                // Show loading state
                const submitBtn = row.querySelector('.submit-btn');
                const originalSubmitHTML = submitBtn.innerHTML;
                submitBtn.innerHTML = '<div class="loading"></div>';
                submitBtn.disabled = true;

                console.log('💾 Submitting tugas changes:', tugasId, tugasData);

                // Call API to update tugas
                const result = await updateTugas(tugasId, tugasData);

                // Restore button
                submitBtn.innerHTML = originalSubmitHTML;
                submitBtn.disabled = false;

                if (result) {
                    // Exit edit mode
                    cancelTugasEdit(tugasId);
                    
                    // Refresh data from server
                    await loadTugas(true);
                }

            } catch (error) {
                console.error('❌ Error submitting tugas changes:', error);
                showNotification('Error update tugas: ' + error.message, 'error');
                
                // Restore button
                const submitBtn = row.querySelector('.submit-btn');
                if (submitBtn) {
                    submitBtn.innerHTML = '<i class="fas fa-check"></i>';
                    submitBtn.disabled = false;
                }
            }
        }

        async function loadPesertaDropdownForEdit(tugasId) {
            const row = document.getElementById(`tugasRow_${tugasId}`);
            if (!row) return;
            
            const assignedToField = row.querySelector('[data-field="assignedTo"] .edit-input');
            if (!assignedToField) return;
            
            // Get current value
            const currentValue = assignedToField.value;
            
            // Load peserta options
            let pesertaList = [];
            if (currentUser && currentUser.role === 'Pembimbing BPS') {
                pesertaList = getPesertaByPembimbing(currentUser.namaLengkap);
            } else {
                const allPeserta = dataCache.peserta || await loadPeserta();
                pesertaList = allPeserta.filter(p => p.Status === 'Aktif');
            }
            
            // Clear and populate dropdown
            assignedToField.innerHTML = '<option value="">Pilih Peserta</option>';
            pesertaList.forEach(peserta => {
                const option = document.createElement('option');
                option.value = peserta['Nama Lengkap'];
                option.textContent = `${peserta['Nama Lengkap']} (${peserta.Kategori})`;
                if (peserta['Nama Lengkap'] === currentValue) {
                    option.selected = true;
                }
                assignedToField.appendChild(option);
            });
        }

        function viewTugasDetail(tugasId) {
            // Find tugas data
            const tugas = dataCache.tugas || [];
            const tugasData = tugas.find(t => (t.ID || t._rowIndex) == tugasId);
            
            if (!tugasData) {
                showNotification('Data tugas tidak ditemukan', 'error');
                return;
            }

            // Show detailed view (you can create a modal for this)
            const details = `
                Judul: ${tugasData['Judul Tugas'] || 'N/A'}
                Assigned To: ${tugasData['Assigned To'] || 'N/A'}
                Deadline: ${tugasData.Deadline || 'N/A'}
                Priority: ${tugasData.Priority || 'N/A'}
                Status: ${tugasData.Status || 'N/A'}
                Deskripsi: ${tugasData.Deskripsi || 'Tidak ada deskripsi'}
            `;
            
            alert(details); // Temporary - you can create a proper modal
        }

        function deleteTugasConfirm(tugasId) {
            if (confirm('Apakah Anda yakin ingin menghapus tugas ini?')) {
                deleteTugasAPI(tugasId);
            }
        }

        function editTugas(rowIndex) {
            // Legacy function - redirect to new edit mode
            toggleTugasEditMode(rowIndex);
        }

        function editLaporan(rowIndex) {
            showNotification('Fitur edit laporan akan segera tersedia', 'info');
        }

        function editSurat(rowIndex) {
            showNotification('Fitur edit surat akan segera tersedia', 'info');
        }

        function editSertifikat(rowIndex) {
            showNotification('Fitur edit sertifikat akan segera tersedia', 'info');
        }

        // Delete Functions
        function deleteUser(userId) {
            if (confirm('Apakah Anda yakin ingin menghapus user ini?')) {
                removeUser(userId);
            }
        }

        // Modal Functions
        function hideAddUserModal() {
            document.getElementById('addUserModal').classList.add('hidden');
            document.getElementById('addUserForm').reset();
        }

        function hideEditUserModal() {
            document.getElementById('editUserModal').classList.add('hidden');
            document.getElementById('editUserForm').reset();
        }

        function hideViewUserModal() {
            document.getElementById('viewUserModal').classList.add('hidden');
        }

        function deletePeserta(rowIndex) {
            if (confirm('Apakah Anda yakin ingin menghapus peserta ini?')) {
                showNotification('Fitur hapus peserta akan segera tersedia', 'info');
            }
        }

        function deleteAbsensi(rowIndex) {
            if (confirm('Apakah Anda yakin ingin menghapus data absensi ini?')) {
                showNotification('Fitur hapus absensi akan segera tersedia', 'info');
            }
        }

        function deleteTugas(rowIndex) {
            if (confirm('Apakah Anda yakin ingin menghapus tugas ini?')) {
                showNotification('Fitur hapus tugas akan segera tersedia', 'info');
            }
        }

        function deleteLaporan(rowIndex) {
            if (confirm('Apakah Anda yakin ingin menghapus laporan ini?')) {
                showNotification('Fitur hapus laporan akan segera tersedia', 'info');
            }
        }

        function deleteSurat(rowIndex) {
            if (confirm('Apakah Anda yakin ingin menghapus surat ini?')) {
                showNotification('Fitur hapus surat akan segera tersedia', 'info');
            }
        }

        function deleteSertifikat(rowIndex) {
            if (confirm('Apakah Anda yakin ingin menghapus sertifikat ini?')) {
                showNotification('Fitur hapus sertifikat akan segera tersedia', 'info');
            }
        }

        // View/Action Functions
        async function approveUser(userId) {
            try {
                if (!confirm('Apakah Anda yakin ingin menyetujui user ini?')) {
                    return;
                }

                console.log('✅ Approving user:', userId);
                
                const result = await apiCall('', 'POST', {
                    action: 'updateUserStatus',
                    sheetId: SHEET_ID,
                    sheetName: 'ADMIN',
                    userId: userId,
                    status: 'Aktif'
                });

                if (result.success) {
                    showNotification('User berhasil disetujui dan diaktifkan!', 'success');
                    loadUsers(true); // Force refresh
                } else {
                    showNotification(result.message || 'Gagal menyetujui user', 'error');
                }
            } catch (error) {
                console.error('❌ Error approving user:', error);
                showNotification('Error menyetujui user: ' + error.message, 'error');
            }
        }

        async function rejectUser(userId) {
            try {
                if (!confirm('Apakah Anda yakin ingin menolak user ini? User akan dihapus dari sistem.')) {
                    return;
                }

                console.log('❌ Rejecting user:', userId);
                
                const result = await apiCall('', 'POST', {
                    action: 'deleteUser',
                    sheetId: SHEET_ID,
                    sheetName: 'ADMIN',
                    userId: userId
                });

                if (result.success) {
                    showNotification('User berhasil ditolak dan dihapus!', 'success');
                    loadUsers(true); // Force refresh
                } else {
                    showNotification(result.message || 'Gagal menolak user', 'error');
                }
            } catch (error) {
                console.error('❌ Error rejecting user:', error);
                showNotification('Error menolak user: ' + error.message, 'error');
            }
        }

        async function toggleUserStatus(userId) {
            try {
                const users = dataCache.users || [];
                const user = users.find(u => (u.ID || u._rowIndex) == userId);
                
                if (!user) {
                    showNotification('Data user tidak ditemukan', 'error');
                    return;
                }

                const currentStatus = user.Status;
                const newStatus = currentStatus === 'Aktif' ? 'Nonaktif' : 'Aktif';
                const action = newStatus === 'Aktif' ? 'mengaktifkan' : 'menonaktifkan';

                if (!confirm(`Apakah Anda yakin ingin ${action} user ini?`)) {
                    return;
                }

                console.log(`🔄 Toggling user status: ${userId} to ${newStatus}`);
                
                const result = await apiCall('', 'POST', {
                    action: 'updateUserStatus',
                    sheetId: SHEET_ID,
                    sheetName: 'ADMIN',
                    userId: userId,
                    status: newStatus
                });

                if (result.success) {
                    showNotification(`User berhasil ${newStatus === 'Aktif' ? 'diaktifkan' : 'dinonaktifkan'}!`, 'success');
                    loadUsers(true); // Force refresh
                } else {
                    showNotification(result.message || `Gagal ${action} user`, 'error');
                }
            } catch (error) {
                console.error('❌ Error toggling user status:', error);
                showNotification('Error mengubah status user: ' + error.message, 'error');
            }
        }

        function viewTugas(rowIndex) {
            showNotification('Fitur lihat detail tugas akan segera tersedia', 'info');
        }

        function viewLaporan(rowIndex) {
            showNotification('Fitur lihat detail laporan akan segera tersedia', 'info');
        }

        function printSurat(rowIndex) {
            showNotification('Fitur cetak surat akan segera tersedia', 'info');
        }

        function downloadSertifikat(rowIndex) {
            showNotification('Fitur download sertifikat akan segera tersedia', 'info');
        }

        // Filter and Search Functions
        function filterAbsensi() {
            const tanggal = document.getElementById('filterTanggalAbsensi').value;
            const status = document.getElementById('filterStatusAbsensi').value;
            showNotification('Fitur filter absensi akan segera tersedia', 'info');
        }

        function searchAbsensi() {
            const searchTerm = document.getElementById('searchAbsensi').value;
            showNotification('Fitur pencarian absensi akan segera tersedia', 'info');
        }

        function filterTugas() {
            const status = document.getElementById('filterStatusTugas').value;
            showNotification('Fitur filter tugas akan segera tersedia', 'info');
        }

        function searchTugas() {
            const searchTerm = document.getElementById('searchTugas').value;
            showNotification('Fitur pencarian tugas akan segera tersedia', 'info');
        }

        function filterLaporan() {
            const status = document.getElementById('filterStatusLaporan').value;
            showNotification('Fitur filter laporan akan segera tersedia', 'info');
        }

        function searchLaporan() {
            const searchTerm = document.getElementById('searchLaporan').value;
            showNotification('Fitur pencarian laporan akan segera tersedia', 'info');
        }

        function filterSurat() {
            const jenis = document.getElementById('filterJenisSurat').value;
            showNotification('Fitur filter surat akan segera tersedia', 'info');
        }

        function searchSurat() {
            const searchTerm = document.getElementById('searchSurat').value;
            showNotification('Fitur pencarian surat akan segera tersedia', 'info');
        }

        function filterSertifikat() {
            const status = document.getElementById('filterStatusSertifikat').value;
            showNotification('Fitur filter sertifikat akan segera tersedia', 'info');
        }

        function searchSertifikat() {
            const searchTerm = document.getElementById('searchSertifikat').value;
            showNotification('Fitur pencarian sertifikat akan segera tersedia', 'info');
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96ffa1231353897d',t:'MTc1NTMzMzY1My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
